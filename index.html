<!doctype html>
<html lang="th" data-density="normal">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <title>อสม.โคกเจริญ — รายงาน</title>

  <!-- Libs -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* ===== Typography & Fluid scales (anti-break when user zooms or enlarge fonts) ===== */
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700;800&display=swap');
    :root{
      /* Base font-size scales fluidly with viewport, but remains friendly to OS font scaling */
      --fs-0: clamp(0.95rem, 0.92rem + 0.30vw, 1.15rem);
      --fs-1: clamp(1.05rem, 1.00rem + 0.45vw, 1.35rem);
      --fs-2: clamp(1.25rem, 1.10rem + 0.80vw, 1.65rem);
      --fs-3: clamp(1.45rem, 1.20rem + 1.10vw, 2.00rem);
      --radius: 16px;
      --radius-sm: 12px;
      --elev: 0 6px 20px rgba(15, 23, 42, .08);
      --elev-strong: 0 12px 32px rgba(15, 23, 42, .15);
      --brand-1: #2563eb; /* indigo-600 */
      --brand-2: #3b82f6; /* blue-500 */
      --ok-1: #16a34a;   /* green-600 */
      --warn-1:#b45309;  /* amber-700 */
      --bad-1:#b91c1c;   /* red-700 */
      --soft: #f8fafc;   /* slate-50 */
    }

    html{
      font-family: 'Sarabun', system-ui, -apple-system, 'Segoe UI', sans-serif;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #0f172a;
    }
    body{ min-height: 100svh; }
    .safe-area{ padding-bottom: env(safe-area-inset-bottom, 0); }

    /* ===== Modern motion, respects reduced-motion ===== */
    @media (prefers-reduced-motion:no-preference){
      .fade-in{ animation: fade-in .5s ease both; }
      .slide-up{ animation: slide-up .6s cubic-bezier(.2,.7,.2,1) both; }
      .pop{ transition: transform .12s ease, box-shadow .2s ease; }
      .pop:active{ transform: translateY(1px) scale(.99); }
    }
    @keyframes fade-in{ from{opacity:0} to{opacity:1} }
    @keyframes slide-up{ from{opacity:0; transform: translateY(10px)} to{opacity:1; transform: translateY(0)} }
    @keyframes spin { from{transform: rotate(0)} to{transform: rotate(360deg)} }
    .spin{ animation: spin 1s linear infinite }

    /* ===== Layout cards with resilient grid (handles zoom/font growth) ===== */
    .cards-grid{
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(min(100%, 22rem), 1fr));
    }

    /* Density modes (auto toggled by ResizeObserver below) */
    [data-density="spacious"] .cards-grid{ gap: 1.25rem; }

    /* ===== Cards ===== */
    .card{
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: var(--radius);
      box-shadow: var(--elev);
      padding: 1.0rem;
    }
    .card-head{
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, var(--brand-2), var(--brand-1));
      color: #fff;
      padding: .9rem 1rem;
      margin:-.25rem -.25rem 1rem;
    }

    .badge-month{ display:inline-flex; align-items:center; gap:.7em; padding:.6em .9em; border-radius:12px; border:2px solid #93c5fd; background:#dbeafe; font-weight:800; font-size:var(--fs-1); color:#1e40af; }
    .status-row{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding: .85rem; background:#f8fafc; border:2px solid #e2e8f0; border-radius:12px; }
    .status-label{ font-size:var(--fs-0); color:#475569; font-weight:700; }
    .chip{ display:inline-flex; align-items:center; justify-content:center; gap:.55em; padding:.65em 1em; border-radius:12px; border:2px solid; font-weight:800; font-size:var(--fs-0); min-width:10ch; text-align:center; }
    .chip-ok{ background:#dcfce7; color:#15803d; border-color:#86efac; }
    .chip-warn{ background:#fef3c7; color:#b45309; border-color:#fcd34d; }
    .chip-bad{ background:#fee2e2; color:#b91c1c; border-color:#fca5a5; }
    .chip-wait{ background:#f3f4f6; color:#4b5563; border-color:#d1d5db; }

    .note-box{ background:#fef2f2; border:2px solid #fecaca; border-radius:12px; padding:.8rem; margin-top:.6rem; }
    .note-title{ color:var(--bad-1); font-weight:800; font-size:var(--fs-0); margin-bottom:.25rem; }
    .note-content{ color:#7f1d1d; font-size:calc(var(--fs-0)*.95); line-height:1.6; white-space:pre-line; }

    /* ===== Header & Controls ===== */
    .font-btn{ width: 2.8rem; height: 2.8rem; background:#fff; color:var(--brand-1); border-radius:12px; border:2px solid #93c5fd; font-weight:800; font-size:var(--fs-1); display:grid; place-items:center; }

    /* ===== Floating Refresh (sized in em, scales with zoom/font) ===== */
    .fab{ position: fixed; right: 1rem; bottom: calc(1rem + env(safe-area-inset-bottom, 0)); z-index: 60; }
    .fab-btn{ width: 4.2em; height: 4.2em; border:0; border-radius:9999px; display:grid; place-items:center; color:#fff; cursor:pointer; background:linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 10px 20px rgba(34,197,94,.35), 0 4px 8px rgba(34,197,94,.25); }
    .fab-btn:active{ transform: translateY(1px) scale(.98); }
    .fab-btn[disabled]{ opacity:.7; cursor:not-allowed; }
    .icon{ width: 1.6em; height: 1.6em; }

    /* ===== Avatar keeps shape even on zoom ===== */
    .avatar{ inline-size: 4.2rem; block-size: 4.2rem; border-radius: 14px; object-fit: cover; border: 2px solid #fff; }

    /* ===== Utilities ===== */
    .sr{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body class="p-4 safe-area fade-in">
  <main class="w-full max-w-3xl mx-auto">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6 slide-up">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl grid place-items-center text-white text-2xl font-extrabold shadow" style="background:linear-gradient(135deg,#22d3ee,#0ea5e9)">อ</div>
        <div>
          <div class="font-extrabold" style="font-size:var(--fs-2)">อสม.โคกเจริญ</div>
          <div class="text-slate-600" style="font-size:calc(var(--fs-0)*.9)">ระบบติดตามงาน</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="font-down" class="font-btn pop" aria-label="ลดขนาดตัวอักษร">A−</button>
        <button id="font-up"   class="font-btn pop" aria-label="เพิ่มขนาดตัวอักษร">A+</button>
      </div>
    </header>

    <!-- Hero -->
    <section class="card slide-up" style="--i:1">
      <div class="card-head">
        <div class="flex items-center gap-4">
          <img id="hero-avatar" class="avatar" src="" alt="รูปโปรไฟล์">
          <div>
            <div class="opacity-90" style="font-size:calc(var(--fs-0)*.9)">สวัสดี</div>
            <div id="hero-name" class="font-extrabold" style="font-size:var(--fs-2)">-</div>
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg border-2 border-blue-200">
          <svg class="icon text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"/></svg>
          <div class="flex-1">
            <div class="text-slate-600" style="font-size:calc(var(--fs-0)*.9)">เลขบัตรประชาชน</div>
            <div id="hero-cid" class="font-extrabold tracking-wider" style="font-size:var(--fs-1)">-</div>
          </div>
        </div>
        <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg border-2 border-green-200">
          <svg class="icon text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
          <div>
            <div class="text-slate-600" style="font-size:calc(var(--fs-0)*.9)">หมู่บ้าน</div>
            <div id="hero-moo" class="font-extrabold" style="font-size:var(--fs-1)">-</div>
          </div>
        </div>
      </div>
    </section>

    <!-- รายงานประจำเดือน -->
    <section class="mt-6 slide-up" style="--i:2">
      <h2 class="font-extrabold mb-3 flex items-center gap-2" style="font-size:var(--fs-2)">
        <svg class="icon text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        รายงานประจำเดือน
      </h2>
      <div id="cards" class="cards-grid"></div>
    </section>

    <!-- ลงทะเบียน -->
    <section id="view-register" class="card hidden slide-up" style="--i:3">
      <div class="card-head">
        <div class="flex items-center gap-4">
          <img id="reg-avatar" class="avatar" src="" alt="รูปโปรไฟล์">
          <div>
            <div class="opacity-90" style="font-size:calc(var(--fs-0)*.9)">ลงทะเบียนครั้งแรก</div>
            <div id="reg-name" class="font-extrabold" style="font-size:var(--fs-1)">-</div>
          </div>
        </div>
      </div>
      <label class="block font-extrabold text-slate-700 mb-3" style="font-size:var(--fs-1)">หมายเลขบัตรประชาชน (13 หลัก)</label>
      <input id="cid" inputmode="numeric" maxlength="13" class="w-full p-4 border-[3px] border-slate-300 rounded-xl text-slate-800 font-bold focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100" style="font-size:var(--fs-1)" placeholder="กรอกเลขบัตรประชาชน 13 หลัก">
      <button id="btn-register" class="mt-4 w-full rounded-xl text-white font-extrabold shadow pop" style="font-size:var(--fs-1); padding:1rem 1.25rem; background:linear-gradient(135deg,#3b82f6,#2563eb)">ยืนยันลงทะเบียน</button>
    </section>

    <!-- Loader -->
    <div id="loader" class="flex flex-col items-center justify-center mt-16">
      <svg class="animate-spin h-12 w-12 text-blue-600 mb-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
      <span class="font-semibold text-slate-700" style="font-size:var(--fs-1)">กำลังโหลด...</span>
    </div>
  </main>

  <!-- Floating Refresh -->
  <div class="fab" aria-live="polite">
    <button id="btn-refresh" class="fab-btn pop" aria-label="โหลดข้อมูลใหม่">
      <svg id="icon-refresh" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M20 9a8 8 0 10-3.86 7.14"/>
      </svg>
      <span class="sr">โหลดข้อมูลใหม่</span>
    </button>
  </div>

  <script>
  /* ===== Config ===== */
  const LIFF_ID  = '2008189191-jnqX2z8B';
  const API_BASE = 'https://script.google.com/macros/s/AKfycbzvrK6QIFKXXCdHj9KzKi4bBk5bHiHZVidfov2V3xmskZ8yZsnar8TNqEbyQHJ3inos/exec';

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const show = el => $(el).classList.remove('hidden');
  const hide = el => $(el).classList.add('hidden');
  const onlyDigit = s => String(s||'').replace(/[^\d]/g,'');
  const okCID = s => onlyDigit(s).length===13;

  function tickIcon(on){
    if(on){
      return `<svg class="icon text-green-600" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
    }
    return `<svg class="icon text-gray-300" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>`;
  }

  /* Card template (resilient to zoom) */
  function cardTemplate(r){
    const planTxt = r.planStatus || 'ยังไม่ได้ส่ง';
    const planCls = r.tick ? 'chip-ok' : 'chip-warn';

    let chkTxt='รอตรวจสอบ', chkCls='chip-wait', noteHtml='';
    const isBad = (r.reportState === 'bad') || /ไม่ผ่าน/.test(r.checkStatus || '');
    if (!isBad && r.reportState === 'ok'){ chkTxt='ถูกต้อง'; chkCls='chip-ok'; }
    else if (isBad){
      chkTxt='ไม่ถูกต้อง'; chkCls='chip-bad';
      if (r.note && String(r.note).trim()){
        const formatted = String(r.note).replace(/•/g, '\n•').replace(/^\n/, '').trim();
        noteHtml = `<div class="note-box"><div class="note-title">📌 หมายเหตุที่ต้องแก้ไข:</div><div class="note-content">${formatted}</div></div>`;
      }
    }

    return `
      <article class="card slide-up">
        <div class="badge-month mb-3">${tickIcon(r.tick)}<span>${r.month}</span></div>
        <div class="space-y-3">
          <div class="status-row"><div class="status-label">📋 สถานะส่งแผน</div><span class="chip ${planCls}">${planTxt}</span></div>
          <div>
            <div class="status-row"><div class="status-label">📊 รายงาน อสม.1</div><span class="chip ${chkCls}">${chkTxt}</span></div>
            ${noteHtml}
          </div>
        </div>
      </article>`;
  }

  /* ===== API ===== */
  async function apiGet(params){
    const url = new URL(API_BASE);
    Object.entries(params).forEach(([k,v])=>url.searchParams.set(k, v));
    const res = await fetch(url.toString(), { method:'GET' });
    return res.json();
  }
  async function apiPost(body){
    const res = await fetch(API_BASE, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(body) });
    return res.json();
  }

  /* ===== A11y font scale (manual controls) ===== */
  const SCALE_KEY = 'osm_a11y_scale_v2';
  function applyScale(val){ document.documentElement.style.fontSize = `calc(16px * ${val})`; localStorage.setItem(SCALE_KEY, String(val)); }
  function loadScale(){ const v = parseFloat(localStorage.getItem(SCALE_KEY) || '1'); applyScale(isNaN(v)?1:v); }
  $('#font-down')?.addEventListener('click', ()=>{ const cur = parseFloat(localStorage.getItem(SCALE_KEY) || '1'); applyScale(Math.max(.85, cur - .05)); });
  $('#font-up')?.addEventListener('click', ()=>{ const cur = parseFloat(localStorage.getItem(SCALE_KEY) || '1'); applyScale(Math.min(1.6, cur + .05)); });

  /* ===== Density auto (responds to zoom / very large fonts) ===== */
  const ro = new ResizeObserver(()=>{
    const r = document.documentElement.getBoundingClientRect();
    // ch per viewport width proxy: if few characters fit per line -> we are zoomed/large fonts
    const chWidth = parseFloat(getComputedStyle(document.documentElement).fontSize); // px of 1rem
    const charsPerLine = r.width / chWidth; // approx
    document.documentElement.dataset.density = (charsPerLine < 30) ? 'spacious' : 'normal';
  });
  ro.observe(document.documentElement);

  /* ===== App Flow ===== */
  let liffProfile=null, userId='', boundCID='';
  let monthsCache=[];
  function toastOk(t='อัปเดตข้อมูลล่าสุดแล้ว'){ Swal.fire({ toast:true, position:'bottom', icon:'success', title:t, showConfirmButton:false, timer:1800, customClass:{ title:'text-base font-bold' } }); }
  function loading(title='กำลังประมวลผล'){ Swal.fire({ title, allowOutsideClick:false, allowEscapeKey:false, didOpen:()=>Swal.showLoading() }); }

  async function main(){
    try{
      loadScale();
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) liff.login();
      const prof = await liff.getProfile(); liffProfile = prof; userId = prof.userId;
      const init = await apiGet({ action:'getorinit', uid:userId });
      if (!init.ok) throw new Error(init.error||'init error');

      if (init.registered){
        boundCID = init.profile.cid;
        $('#hero-avatar').src = init.profile.linepic || prof.pictureUrl || '';
        $('#hero-name').textContent = init.profile.linename || prof.displayName || '-';
        await renderHome(boundCID);
      }else{
        hide('#loader'); show('#view-register');
        $('#reg-avatar').src = prof.pictureUrl || ''; $('#reg-name').textContent = prof.displayName || '-';
      }
    }catch(err){ hide('#loader'); Swal.fire({ title:'เกิดข้อผิดพลาด', text: err.message, icon:'error' }); }
  }

  async function renderHome(cid){
    loading('กำลังโหลดข้อมูล...');
    const st = await apiGet({ action:'status', cid });
    Swal.close();
    if (!st.ok){ return Swal.fire({ title:'โหลดข้อมูลไม่สำเร็จ', text: st.error||'', icon:'error' }); }

    monthsCache = st.months || [];
    $('#hero-name').textContent = st.info?.linename || liffProfile?.displayName || '-';
    $('#hero-avatar').src = st.info?.linepic || liffProfile?.pictureUrl || '';
    $('#hero-cid').textContent = cid;
    $('#hero-moo').textContent = st.info?.moo || '-';

    hide('#loader');
    const cards = monthsCache.map(cardTemplate).join('');
    // Mount with small transition
    const el = document.getElementById('cards');
    el.innerHTML = cards;
  }

  // Register
  $('#btn-register')?.addEventListener('click', async ()=>{
    const cid = onlyDigit($('#cid').value);
    if (!okCID(cid)) return Swal.fire({ title:'ข้อมูลไม่ถูกต้อง', text:'กรุณากรอกเลขบัตร 13 หลัก', icon:'warning' });
    loading('กำลังลงทะเบียน...');
    const rs = await apiPost({ action:'register', cid, uid: userId, linename: liffProfile?.displayName || '', linepic:  liffProfile?.pictureUrl || '' });
    Swal.close();
    if (!rs.ok) return Swal.fire({ title:'ลงทะเบียนไม่สำเร็จ', text: rs.error||'', icon:'error' });
    boundCID = cid; Swal.fire({ title:'สำเร็จ', text:'ลงทะเบียนเรียบร้อย', icon:'success' });
    await renderHome(boundCID);
  });

  // FAB refresh
  const btnRefresh = document.getElementById('btn-refresh');
  const iconRefresh = document.getElementById('icon-refresh');
  let refreshing = false, lastRefreshAt = 0;
  function setRefreshBusy(b){ refreshing=b; btnRefresh.disabled=b; iconRefresh.classList.toggle('spin', b); }
  async function refreshData(){
    if (refreshing) return; const now = Date.now(); if (now - lastRefreshAt < 1200) return; lastRefreshAt = now;
    try{ setRefreshBusy(true); boundCID ? (await renderHome(boundCID), toastOk()) : await main(); }
    catch(err){ Swal.fire({ icon:'error', title:'รีเฟรชไม่สำเร็จ', text: err.message }); }
    finally{ setRefreshBusy(false); }
  }
  btnRefresh?.addEventListener('click', refreshData);
  document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible' && boundCID){ refreshData(); } });

  // Start
  main();
  </script>
</body>
</html>
