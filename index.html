<!doctype html>
<html lang="th" class="h-full touch-manipulation">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#16a34a"/>
  <title>อสม. – ยืนยันตัวตน & แสดงข้อมูล</title>

  <!-- LIFF + Tailwind -->
  <link rel="preconnect" href="https://static.line-scdn.net"/>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { DEFAULT: '#16a34a', 600: '#16a34a' }},
          boxShadow: { soft: '0 6px 24px rgba(0,0,0,.07)' }
        }
      }
    };
  </script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{--safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)}
    .safe-top{padding-top:max(.5rem,var(--safe-top))}
    .safe-bottom{padding-bottom:max(.75rem,var(--safe-bottom))}
    .line-clamp-1{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
    .fade-in{animation:fade-in .2s ease both}
    @keyframes fade-in{from{opacity:0;transform:translateY(2px)}to{opacity:1;transform:none}}
    /* Spinner overlay */
    #loadingOverlay{position:fixed;inset:0;background:rgba(255,255,255,.65);backdrop-filter:saturate(120%) blur(2px);display:none;z-index:9999}
    .spinner{width:46px;height:46px;border:4px solid rgba(16,185,129,.25);border-top-color:#10b981;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="h-full bg-gray-50 text-gray-900">
  <!-- Loading overlay -->
  <div id="loadingOverlay" class="grid place-items-center">
    <div class="spinner"></div>
  </div>

  <!-- Header -->
  <header class="safe-top sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-md mx-auto flex items-center gap-3 p-3">
      <div class="w-9 h-9 rounded-xl grid place-items-center bg-emerald-100 text-emerald-700">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M5 21q-1.25 0-2.125-.875T2 18q0-3.35 2.325-5.675Q6.65 10 10 10h6q.825 0 1.413.587T18 12v2q0 2.9-2.05 4.95T11 21H5Zm14-9q-1.65 0-2.825-1.175T15 8q0-1.65 1.175-2.825T19 4q1.65 0 2.825 1.175T23 8q0 1.65-1.175 2.825T19 12Z"/></svg>
      </div>
      <div class="flex-1 min-w-0">
        <div class="text-base font-semibold leading-5 line-clamp-1">อสม. – ระบบยืนยันตัวตน</div>
        <div class="text-xs text-gray-500">ตรวจสอบก่อน ถ้าไม่พบจึงให้ยืนยัน</div>
      </div>
      <button id="btnRefresh" class="text-sm px-3 py-1.5 rounded-full bg-gray-100 hover:bg-gray-200 active:bg-gray-300">รีเฟรช</button>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-md mx-auto p-4 pb-24">
    <!-- สถานะแบบย่อ -->
    <div id="status" class="hidden mt-1 px-3 py-2 rounded-xl text-sm"></div>

    <!-- โปรไฟล์ (โชว์ทันทีถ้าพบการผูก) -->
    <section id="profileCard" class="hidden mt-4 bg-white rounded-2xl shadow-soft border border-gray-100">
      <div class="p-4 flex items-center gap-3">
        <img id="pic" class="w-14 h-14 rounded-2xl object-cover bg-gray-100" alt="profile"/>
        <div class="min-w-0">
          <div id="displayName" class="font-semibold leading-5 line-clamp-1">—</div>
          <div id="cid" class="text-xs text-gray-500">CID: —</div>
        </div>
      </div>
      <div class="px-4 pb-4 grid grid-cols-2 gap-3 text-sm">
        <div class="p-3 rounded-xl bg-gray-50"><div class="text-gray-500 text-xs">ชื่อ-นามสกุล</div><div id="f_fullname" class="font-medium break-words">—</div></div>
        <div class="p-3 rounded-xl bg-gray-50"><div class="text-gray-500 text-xs">วันเกิด</div><div id="f_dob" class="font-medium break-words">—</div></div>
        <div class="p-3 rounded-xl bg-gray-50 col-span-2"><div class="text-gray-500 text-xs">ที่อยู่</div><div id="f_addr" class="font-medium break-words">—</div></div>
        <div class="p-3 rounded-xl bg-gray-50"><div class="text-gray-500 text-xs">หมู่ที่</div><div id="f_moo" class="font-medium">—</div></div>
        <div class="p-3 rounded-xl bg-gray-50"><div class="text-gray-500 text-xs">ตำบล</div><div id="f_tambon" class="font-medium">—</div></div>
        <div class="p-3 rounded-xl bg-gray-50"><div class="text-gray-500 text-xs">อำเภอ</div><div id="f_amphoe" class="font-medium">—</div></div>
        <div class="p-3 rounded-xl bg-gray-50"><div class="text-gray-500 text-xs">จังหวัด</div><div id="f_changwat" class="font-medium">—</div></div>
        <div class="p-3 rounded-xl bg-gray-50"><div class="text-gray-500 text-xs">เลขสถานบริการ</div><div id="f_fac" class="font-medium">—</div></div>
        <div class="p-3 rounded-xl bg-gray-50"><div class="text-gray-500 text-xs">วันที่ขึ้นทะเบียน</div><div id="f_reg" class="font-medium">—</div></div>
        <div class="p-3 rounded-xl bg-gray-50"><div class="text-gray-500 text-xs">เบอร์โทรศัพท์</div><div id="f_phone" class="font-medium">—</div></div>
        <div class="p-3 rounded-xl bg-gray-50"><div class="text-gray-500 text-xs">บัญชีปฎิบัติงานอสม.</div><div id="f_acc" class="font-medium break-words">—</div></div>
        <div class="p-3 rounded-xl bg-gray-50"><div class="text-gray-500 text-xs">สถานะ อสม.</div><div id="f_status" class="font-medium">—</div></div>
      </div>
    </section>

    <!-- ฟอร์มยืนยัน (ถูกซ่อนตั้งแต่เริ่ม และจะแสดงเมื่อ mapped=false) -->
    <section id="enrollCard" class="hidden mt-6 bg-white rounded-2xl shadow-soft border border-gray-100">
      <div class="p-4">
        <div class="font-semibold mb-1">ยืนยันตัวตนใน LINE</div>
        <p class="text-xs text-gray-500 mb-3">กรอก <b>CID</b> เพื่อผูกกับ LINE ของคุณ (จะบันทึกชื่อและรูปโปรไฟล์ด้วย)</p>
        <label class="block text-xs text-gray-600">หมายเลขบัตรประชาชน (13 หลัก)</label>
        <input id="cidInput" inputmode="numeric" maxlength="13"
               class="mt-1 w-full px-3 py-2 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500"
               placeholder="เช่น 1169800190675"/>
        <button id="btnEnroll" class="w-full mt-3 py-3 rounded-xl bg-emerald-600 text-white font-medium active:scale-[.99]">
          ยืนยันตัวตนใน LINE
        </button>
      </div>
    </section>
  </main>

  <!-- Bottom Bar (ไว้สลับดู/รีเฟรช) -->
  <nav class="safe-bottom fixed bottom-0 inset-x-0 z-40 bg-white/90 backdrop-blur border-t border-gray-200">
    <div class="max-w-md mx-auto flex items-center justify-between px-4">
      <button id="btnShowProfile" class="py-3 text-emerald-700 text-sm">ข้อมูล อสม.</button>
    </div>
  </nav>

  <script>
    // ===== ใส่ค่าของคุณก่อนใช้งาน =====
    const LIFF_ID = '2008189191-jnqX2z8B';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw32HUvnQsJ_Yvv49ZHKACjxG7zzg2xX5xQjMPT2FcpiFhB5gNAwFk-_hQizN9Kp-16/exec';

    // ===== Utilities =====
    const $ = (id)=> document.getElementById(id);
    const show = (id)=> $(id).classList.remove('hidden');
    const hide = (id)=> $(id).classList.add('hidden');
    const overlay = $('loadingOverlay');
    const loading = (on)=> overlay.style.display = on ? 'grid' : 'none';
    const setStatus=(msg,type='info')=>{
      const el=$('status');
      el.textContent = msg || '';
      el.className='mt-1 px-3 py-2 rounded-xl text-sm '+(
        type==='ok'  ? 'bg-emerald-50 text-emerald-700 border border-emerald-200' :
        type==='err' ? 'bg-rose-50 text-rose-700 border border-rose-200' :
                       'bg-gray-50 text-gray-700 border border-gray-200'
      );
      el.classList.remove('hidden');
    };

    // ---- API (เลี่ยง CORS/preflight) ----
    async function apiGet(action, params = {}) {
      const u = new URL(APPS_SCRIPT_URL);
      u.searchParams.set('action', action);
      Object.entries(params).forEach(([k,v])=> u.searchParams.set(k, v));
      const res = await fetch(u.toString(), { method: 'GET' });
      if(!res.ok) throw new Error('Network');
      return res.json();
    }
    async function apiPost(action, body = {}) {
      const res = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action, ...body })
      });
      if(!res.ok) throw new Error('Network');
      return res.json();
    }

    // ---- UI logic ----
    function renderProfile(p, dispName, picUrl){
      show('profileCard');
      $('displayName').textContent = dispName || p['LINE_DISPLAY_NAME'] || '-';
      $('pic').src   = picUrl || p['LINE_PICTURE_URL'] || '';
      $('cid').textContent = 'CID: ' + (p['หมายเลขบัตรประชาชน'] || '—');
      $('f_fullname').textContent = p['ชื่อ-นามสกุล'] || '—';
      $('f_dob').textContent      = p['วันเกิด'] || '—';
      $('f_addr').textContent     = p['ที่อยู่'] || '—';
      $('f_moo').textContent      = p['หมู่ที่'] || '—';
      $('f_tambon').textContent   = p['ตำบล'] || '—';
      $('f_amphoe').textContent   = p['อำเภอ'] || '—';
      $('f_changwat').textContent = p['จังหวัด'] || '—';
      $('f_fac').textContent      = p['เลขสถานบริการ'] || '—';
      $('f_reg').textContent      = p['วันที่ขึ้นทะเบียน'] || '—';
      $('f_phone').textContent    = p['เบอร์โทรศัพท์'] || '—';
      $('f_acc').textContent      = p['บัญชีปฎิบัติงานอสม.'] || '—';
      $('f_status').textContent   = p['สถานะ อสม.'] || '—';
    }

    function showEnrollOnly(){
      hide('profileCard');
      show('enrollCard');
    }
    function showProfileOnly(){
      hide('enrollCard');
      show('profileCard');
    }

    // ---- App state ----
    let gUserId='', gProfile=null;

    async function bootstrap(){
      try{
        loading(true);
        setStatus('กำลังเริ่มต้นระบบ…');
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }

        const prof = await liff.getProfile();
        gProfile = prof; gUserId = prof.userId;

        const init = await apiGet('init', { userId: gUserId });
        if(!init.ok){ setStatus('เริ่มต้นไม่สำเร็จ','err'); showEnrollOnly(); return; }

        if(init.mapped){
          setStatus('พบการยืนยันตัวตนแล้ว','ok');
          renderProfile(init.profile, gProfile?.displayName, gProfile?.pictureUrl);
          showProfileOnly(); // ✅ โปรไฟล์เท่านั้น
        } else {
          setStatus('ยังไม่ได้ยืนยันตัวตน กรุณากรอก CID เพื่อผูกบัญชี','info');
          showEnrollOnly();  // ✅ แสดงฟอร์มเฉพาะเมื่อไม่พบ
        }
      }catch(err){
        console.error(err);
        setStatus('เกิดข้อผิดพลาดในการเริ่มต้น','err');
        showEnrollOnly();
      }finally{
        loading(false);
      }
    }

    // ---- Events ----
    $('btnEnroll').addEventListener('click', async ()=>{
      const cid = ($('cidInput').value || '').trim();
      if(!/^\d{13}$/.test(cid)){
        Swal.fire({ icon:'warning', title:'กรุณากรอก CID 13 หลัก', confirmButtonColor:'#16a34a' });
        return;
      }
      try{
        loading(true);
        const r = await apiPost('enroll', {
          cid,
          userId: gUserId,
          displayName: gProfile?.displayName || '',
          pictureUrl: gProfile?.pictureUrl || ''
        });
        if(r.ok){
          Swal.fire({ icon:'success', title: r.bound ? 'ผูกบัญชีสำเร็จ' : 'บันทึกแล้ว', confirmButtonColor:'#16a34a' });
          // ดึงโปรไฟล์ล่าสุด
          const init = await apiGet('init', { userId: gUserId });
          if(init?.mapped){
            renderProfile(init.profile, gProfile?.displayName, gProfile?.pictureUrl);
            showProfileOnly();
            setStatus('ยืนยันตัวตนแล้ว','ok');
          }
        } else {
          let msg = 'ไม่สามารถยืนยันได้';
          if(r.error === 'cid_not_found') msg = 'ไม่พบ CID นี้ในระบบ';
          if(r.error === 'cid_already_linked_to_other') msg = 'CID นี้ถูกผูกกับบัญชีอื่นแล้ว';
          Swal.fire({ icon:'error', title: msg, confirmButtonColor:'#16a34a' });
          setStatus('ผิดพลาด: ' + (r.error||''), 'err');
        }
      }catch(err){
        Swal.fire({ icon:'error', title:'เครือข่ายผิดพลาด', confirmButtonColor:'#16a34a' });
      }finally{
        loading(false);
      }
    });

    $('btnRefresh').addEventListener('click', ()=> bootstrap());
    $('btnShowEnroll').addEventListener('click', ()=> showEnrollOnly());
    $('btnShowProfile').addEventListener('click', ()=> showProfileOnly());

    // Start
    bootstrap();
  </script>
</body>
</html>
