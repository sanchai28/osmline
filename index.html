<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SMART CARE – OSM LIFF</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body{ background: radial-gradient(80% 60% at 20% 10%, #ff7bd5 0%, #7b61ff 40%, #1abc9c 100%) fixed; }
    .card{ @apply bg-white rounded-3xl shadow-xl; }
    .chip{ @apply text-xs px-2 py-1 rounded-full; }
    .tick{ width: 22px; height: 22px; }
    .safe-area{ padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 safe-area">
  <div id="app" class="w-full max-w-sm">

    <header class="flex items-center justify-between text-white/95 mb-4">
      <div class="text-lg font-semibold tracking-wide">SMART CARE</div>
      <div id="notifDot" class="w-3 h-3 rounded-full bg-yellow-300 animate-pulse"></div>
    </header>

    <!-- Register -->
    <section id="view-register" class="card p-5 hidden">
      <div class="flex items-center gap-3">
        <img id="reg-avatar" class="w-12 h-12 rounded-full object-cover" src="" alt="">
        <div class="font-semibold leading-tight">
          <div id="reg-name">-</div>
          <div class="text-xs text-gray-500">ลงทะเบียนใช้งานครั้งแรก</div>
        </div>
      </div>

      <div class="mt-4">
        <label class="block text-sm font-medium mb-1">หมายเลขบัตรประชาชน (13 หลัก)</label>
        <input id="cid" inputmode="numeric" maxlength="13"
               class="w-full rounded-2xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500"
               placeholder="กรอกเลขบัตรประชาชน" />
        <p class="text-xs text-gray-500 mt-1">* ใช้สำหรับจับคู่ข้อมูลกับระบบ อสม.</p>
      </div>

      <button id="btn-register"
              class="mt-4 w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-2xl active:scale-[0.99]">
        ยืนยันลงทะเบียน
      </button>
    </section>

    <!-- Home -->
    <section id="view-home" class="hidden">
      <div class="card p-5">
        <div class="flex items-center gap-3">
          <img id="pfp" class="w-14 h-14 rounded-2xl object-cover" src="" alt="">
          <div class="grow">
            <div id="pf-name" class="font-semibold text-lg leading-tight">-</div>
            <div class="text-sm text-gray-500">
              <span id="pf-cid">-</span> · หมู่ <span id="pf-moo">-</span>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4 card p-5">
        <div class="flex items-center justify-between">
          <div class="font-semibold">สถานะการส่งแผน (รายเดือน)</div>
          <span class="chip bg-gray-100">ปีงบประมาณ</span>
        </div>
        <div id="month-list" class="mt-3 divide-y"></div>
      </div>

      <div class="h-8"></div>
    </section>

    <div id="loader" class="flex items-center justify-center text-white mt-10">
      <svg class="animate-spin h-6 w-6 mr-2" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle>
        <path class="opacity-75" fill="white" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <span>กำลังโหลด…</span>
    </div>

  </div>

<script>
/* ===== Config (ใส่ค่าจริง) ===== */
const LIFF_ID  = '2008189191-jnqX2z8B';
const API_BASE = 'https://script.google.com/macros/s/AKfycbyOs1VkVy2FaqrWS_bMg8tr89VtiZkmaPvRt8h1WesrLev6R_V7uLcdy9EocE9oHAKW/exec';


/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const show = id => $(id).classList.remove('hidden');
const hide = id => $(id).classList.add('hidden');
function checkCID(x){ return /^\d{13}$/.test(String(x||'').trim()); }
function rowTemplate(r){
  const tick = r.tick
    ? `<svg class="tick text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>`
    : `<svg class="tick text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg>`;
  let chipCls = 'bg-gray-100 text-gray-600', chipTxt = 'รอตรวจสอบ';
  if (r.reportState === 'ok') { chipCls = 'bg-emerald-100 text-emerald-700'; chipTxt = 'ส่งรายงาน อสม.1 ถูกต้อง'; }
  else if (r.reportState === 'bad') { chipCls = 'bg-rose-100 text-rose-700'; chipTxt = 'ยังไม่ถูกต้อง'; }
  const planText = r.planStatus || 'ยังไม่ได้ส่ง';
  const planCls  = r.tick ? 'text-emerald-700' : 'text-amber-600';
  return `
  <div class="py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      ${tick}
      <div>
        <div class="font-medium">${r.month}</div>
        <div class="text-xs ${planCls}">สถานะ: ${planText}</div>
      </div>
    </div>
    <div class="chip ${chipCls}">${chipTxt}</div>
  </div>`;
}

async function apiGet(params){
  const url = new URL(API_BASE);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  // GET เป็น simple request อยู่แล้ว → ไม่โดน preflight
  const res = await fetch(url.toString(), { method:'GET' });
  return res.json();
}
async function apiPost(body){
  // ใช้ text/plain เพื่อเลี่ยง preflight CORS
  const res = await fetch(API_BASE, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify(body)
  });
  return res.json();
}

/* ===== App Flow ===== */
let liffProfile = null;
let userId = '';
let boundCID = '';

function swalLoading(title='กำลังประมวลผล'){
  Swal.fire({
    title, allowOutsideClick:false, allowEscapeKey:false, didOpen: () => Swal.showLoading()
  });
}

async function main(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();

    const prof = await liff.getProfile();
    liffProfile = prof; userId = prof.userId;

    const init = await apiGet({ action:'getorinit', uid:userId });
    if (!init.ok) throw new Error(init.error || 'init error');

    if (init.registered){
      boundCID = init.profile.cid;
      await renderHome(boundCID, init.profile);
    } else {
      $('#reg-avatar').src = prof.pictureUrl || '';
      $('#reg-name').textContent = prof.displayName || '-';
      hide('#loader'); show('#view-register');
    }
  }catch(err){
    hide('#loader');
    Swal.fire('เกิดข้อผิดพลาด', err.message, 'error');
  }
}

async function renderHome(cid, infoFromInit=null){
  hide('#loader'); swalLoading('กำลังโหลดสถานะ');
  const st = await apiGet({ action:'status', cid });
  Swal.close();
  if (!st.ok) { Swal.fire('โหลดข้อมูลไม่สำเร็จ', st.error || '', 'error'); return; }

  const info = st.info || infoFromInit || {};
  $('#pfp').src = (info.linepic || liffProfile?.pictureUrl || '');
  $('#pf-name').textContent = info.name || liffProfile?.displayName || '-';
  $('#pf-cid').textContent = cid;
  $('#pf-moo').textContent = info.moo || '-';
  $('#month-list').innerHTML = st.months.map(rowTemplate).join('');
  show('#view-home');
}

$('#btn-register').addEventListener('click', async () => {
  const cid = $('#cid').value.trim();
  if (!checkCID(cid)) { Swal.fire('ข้อมูลไม่ถูกต้อง','กรุณากรอกเลขบัตรประชาชน 13 หลัก','warning'); return; }
  swalLoading('กำลังลงทะเบียน…');

  const rs = await apiPost({
    action:'register',
    cid,
    uid: userId,
    linename: liffProfile?.displayName || '',
    linepic:  liffProfile?.pictureUrl || ''
  });
  Swal.close();

  if (!rs.ok) { Swal.fire('ลงทะเบียนไม่สำเร็จ', rs.error || '', 'error'); return; }

  boundCID = cid;
  Swal.fire('สำเร็จ','ลงทะเบียนเรียบร้อย','success');
  await renderHome(boundCID);
});

main();
</script>
</body>
</html>
