<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <title>‡∏≠‡∏™‡∏°.‡πÇ‡∏Ñ‡∏Å‡πÄ‡∏à‡∏£‡∏¥‡∏ç ‚Äî Purple UI</title>
  
  <!-- Libs -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700;800&display=swap');
    :root{
      --bg: #f5f3ff;           /* violet-50 */
      --card: #ffffff;
      --vio-500:#8b5cf6;       /* violet-500 */
      --vio-600:#7c3aed;       /* violet-600 */
      --vio-700:#6d28d9;       /* violet-700 */
      --mint:#34d399;          /* emerald-400 */
      --soft-shadow: 0 8px 24px rgba(109, 40, 217, .18);
      --neo-in: inset 6px 6px 12px rgba(0,0,0,.06), inset -6px -6px 12px rgba(255,255,255,.9);
      --neo-out: 6px 6px 16px rgba(109,40,217,.18), -6px -6px 16px rgba(255,255,255,.9);
    }
    html{ font-family:'Sarabun', system-ui, -apple-system, 'Segoe UI', sans-serif; background: var(--bg); color:#0f172a; }
    body{ min-height:100svh; }

    /* Purple glass header */
    .hero-wrap{ position:relative; }
    .hero-bg{
      background: radial-gradient(120% 120% at 10% 0%, #c4b5fd 0%, #a78bfa 40%, #7c3aed 100%);
      height: 220px;
      border-bottom-left-radius: 36px;
      border-bottom-right-radius: 36px;
      box-shadow: var(--soft-shadow);
    }
    .hero-wave{
      position:absolute; inset:0; pointer-events:none; opacity:.25;
      background:
        radial-gradient(80px 80px at 20% 35%, rgba(255,255,255,.8) 0 50%, transparent 51%),
        radial-gradient(120px 120px at 70% 20%, rgba(255,255,255,.5) 0 40%, transparent 41%);
      mix-blend-mode:soft-light;
    }

    .glass-card{
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.7);
      border-radius: 18px;
      box-shadow: var(--neo-out);
    }
    .neo-in{ box-shadow: var(--neo-in); }

    .chip{ display:inline-flex; align-items:center; gap:.55em; padding:.5rem .85rem; border-radius:999px; font-weight:800; font-size:0.95rem; }
    .chip-ok{ color:#065f46; background:#d1fae5; }
    .chip-warn{ color:#92400e; background:#fef3c7; }
    .chip-bad{ color:#991b1b; background:#fee2e2; }
    .chip-wait{ color:#334155; background:#f1f5f9; }

    .icon{ width:1.4rem; height:1.4rem; }

    /* Bottom nav */
    .tabbar{
      position:sticky; bottom:0; inset-inline:0; z-index:40;
      padding: .65rem .9rem; margin-top: 1rem;
      background:rgba(255,255,255,.9); backdrop-filter: blur(8px);
      border-top-left-radius: 18px; border-top-right-radius: 18px;
      border:1px solid rgba(255,255,255,.8);
      box-shadow: 0 -6px 20px rgba(124,58,237,.12);
    }
    .tab-btn{ display:grid; place-items:center; gap:.25rem; font-size:.8rem; color:#6b7280; font-weight:700; }
    .tab-btn[aria-current="page"]{ color:var(--vio-700); }

    /* Floating action */
    .fab{ position: fixed; right: 1rem; bottom: calc(1rem + env(safe-area-inset-bottom, 0)); z-index: 60; }
    .fab-btn{ width:4.2em; height:4.2em; border:0; border-radius:999px; display:grid; place-items:center; color:#fff; cursor:pointer;
      background: linear-gradient(135deg, var(--vio-600), var(--vio-700)); box-shadow: 0 12px 26px rgba(124,58,237,.35); }
    .fab-btn:active{ transform: translateY(1px) scale(.98); }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

    /* Animations */
    @media (prefers-reduced-motion:no-preference){
      .fade-in{ animation: fade-in .45s ease both; }
      .rise{ animation: rise .6s cubic-bezier(.2,.7,.2,1) both; }
    }
    @keyframes fade-in{ from{opacity:0} to{opacity:1} }
    @keyframes rise{ from{opacity:0; transform: translateY(10px)} to{opacity:1; transform: translateY(0)} }
  </style>
</head>
<body class="safe-area">
  <!-- Header -->
  <header class="hero-wrap">
    <div class="hero-bg"></div>
    <div class="hero-wave"></div>

    <div class="px-5 pt-6 relative">
      <div class="flex items-center justify-between text-white">
        <div>
          <div class="text-sm opacity-90">Hi, <span id="hero-short">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏≠‡∏™‡∏°.</span></div>
          <h1 class="text-2xl font-extrabold leading-tight">‡∏≠‡∏™‡∏°.‡πÇ‡∏Ñ‡∏Å‡πÄ‡∏à‡∏£‡∏¥‡∏ç</h1>
          <p class="text-white/90 -mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</p>
        </div>
        <img id="hero-avatar" class="w-12 h-12 rounded-2xl border-2 border-white object-cover" src="" alt="avatar"/>
      </div>

      <!-- Search / Month selector card -->
      <div class="mt-5 glass-card p-4 text-slate-700 rise">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-500">‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</div>
            <div id="hero-cid" class="font-extrabold text-slate-800">-</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</div>
            <div id="hero-moo" class="font-extrabold text-slate-800">-</div>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-2">
          <select id="month-select" class="neo-in w-full p-3 rounded-xl bg-white/90">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
          </select>
          <button id="btn-search" class="w-full rounded-xl text-white font-extrabold shadow"
            style="background:linear-gradient(135deg, var(--vio-500), var(--vio-700)); padding:.9rem 1rem;">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="px-5 pb-24 -mt-3">
    <section class="mb-3">
      <h2 class="text-slate-800 text-lg font-extrabold mb-2">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
      <div id="cards" class="grid gap-3">
        <!-- filled by JS -->
      </div>
    </section>

    <!-- Register Panel -->
    <section id="view-register" class="glass-card p-4 hidden">
      <div class="flex items-center gap-3 mb-3">
        <img id="reg-avatar" class="w-12 h-12 rounded-xl object-cover border-2 border-white" src="" alt="avatar"/>
        <div>
          <div class="text-xs text-slate-500">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</div>
          <div id="reg-name" class="text-base font-extrabold">-</div>
        </div>
      </div>
      <label class="block font-bold text-slate-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)</label>
      <input id="cid" inputmode="numeric" maxlength="13" class="w-full p-4 rounded-xl border-2 border-violet-200 focus:outline-none focus:border-violet-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£"/>
      <button id="btn-register" class="mt-3 w-full rounded-xl text-white font-extrabold"
        style="background:linear-gradient(135deg, var(--vio-500), var(--vio-700)); padding: .9rem 1rem;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    </section>

    <!-- Loader -->
    <div id="loader" class="flex flex-col items-center justify-center py-14 text-violet-700">
      <svg class="animate-spin h-10 w-10 mb-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
      <span class="font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
    </div>
  </main>

  <!-- Bottom navigation -->
  <nav class="tabbar grid grid-cols-4 gap-3">
    <button class="tab-btn" aria-current="page">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l2-2 7-7 7 7 2 2v8a2 2 0 01-2 2h-3a1 1 0 01-1-1v-4a1 1 0 00-1-1h-2a1 1 0 00-1 1v4a1 1 0 01-1 1H5a2 2 0 01-2-2z"/></svg>
      <span>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
    </button>
    <button class="tab-btn">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v11a2 2 0 002 2z"/></svg>
      <span>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
    </button>
    <button class="tab-btn">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8c-1.657 0-3 1.343-3 3v5h6v-5c0-1.657-1.343-3-3-3z"/><path d="M5 20h14"/></svg>
      <span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
    </button>
    <button class="tab-btn">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      <span>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
    </button>
  </nav>

  <!-- Floating Refresh -->
  <div class="fab">
    <button id="btn-refresh" class="fab-btn" aria-label="‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà">
      <svg id="icon-refresh" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M20 9a8 8 0 10-3.86 7.14"/>
      </svg>
    </button>
  </div>

  <script>
  /* ===== Config ===== */
  const LIFF_ID  = '2008189191-jnqX2z8B';
  const API_BASE = 'https://script.google.com/macros/s/AKfycbzvrK6QIFKXXCdHj9KzKi4bBk5bHiHZVidfov2V3xmskZ8yZsnar8TNqEbyQHJ3inos/exec';

  /* ===== Utils ===== */
  const $ = (s)=>document.querySelector(s);
  const show = (s)=>$(s).classList.remove('hidden');
  const hide = (s)=>$(s).classList.add('hidden');
  const onlyDigit = s => String(s||'').replace(/[^\d]/g,'');
  const okCID = s => onlyDigit(s).length===13;

  function toastOK(t='‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß'){
    Swal.fire({ toast:true, position:'bottom', icon:'success', title:t, timer:1600, showConfirmButton:false });
  }

  /* ===== API ===== */
  async function apiGet(params){
    const url = new URL(API_BASE);
    Object.entries(params).forEach(([k,v])=>url.searchParams.set(k, v));
    const res = await fetch(url.toString(), { method:'GET' });
    return res.json();
  }
  async function apiPost(body){
    const res = await fetch(API_BASE, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(body) });
    return res.json();
  }

  /* ===== Cards ===== */
  function tickIcon(on){
    if(on) return '<svg class="w-5 h-5 text-emerald-600" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>';
    return '<svg class="w-5 h-5 text-slate-300" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>';
  }

  function cardTemplate(r){
    const planTxt = r.planStatus || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á';
    const planCls = r.tick ? 'chip-ok' : 'chip-warn';
    let chkTxt='‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', chkCls='chip-wait', noteHtml='';
    const isBad = (r.reportState === 'bad') || /‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô/.test(r.checkStatus || '');
    if (!isBad && r.reportState === 'ok'){ chkTxt='‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; chkCls='chip-ok'; }
    else if (isBad){ chkTxt='‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; chkCls='chip-bad'; if (r.note && String(r.note).trim()){ noteHtml = `<div class='mt-2 text-sm text-rose-800 bg-rose-50 border border-rose-200 rounded-lg p-3'>üìå ${r.note}</div>`; } }

    return `
      <article class="glass-card p-4 fade-in">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            ${tickIcon(r.tick)}
            <div class="font-extrabold text-slate-800">${r.month}</div>
          </div>
          <span class="chip ${planCls}">${planTxt}</span>
        </div>
        <div class="mt-3 flex items-center justify-between">
          <div class="text-slate-600 font-bold">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏≠‡∏™‡∏°.1</div>
          <span class="chip ${chkCls}">${chkTxt}</span>
        </div>
        ${noteHtml}
      </article>`;
  }

  /* ===== App Flow ===== */
  let liffProfile=null, userId='', boundCID='';
  let monthsCache=[];
  const btnRefresh = $('#btn-refresh');
  const iconRefresh = $('#icon-refresh');
  let refreshing=false, lastRefreshAt=0;
  function setRefreshBusy(b){ refreshing=b; btnRefresh.disabled=b; iconRefresh.classList.toggle('spin', b); }

  async function renderHome(cid){
    const st = await apiGet({ action:'status', cid });
    if(!st.ok){ hide('#loader'); return Swal.fire({ icon:'error', title:'‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: st.error||'' }); }
    monthsCache = st.months||[];
    $('#hero-short').textContent = st.info?.linename?.split(' ')?.[0] || '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏≠‡∏™‡∏°.';
    $('#hero-avatar').src = st.info?.linepic || liffProfile?.pictureUrl || '';
    $('#hero-cid').textContent = cid; $('#hero-moo').textContent = st.info?.moo || '-';

    // month select
    const msel = $('#month-select');
    msel.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>' + monthsCache.map(m=>`<option>${m.month}</option>`).join('');

    // cards
    $('#cards').innerHTML = monthsCache.map(cardTemplate).join('');
    hide('#loader');
  }

  async function main(){
    try{
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()) liff.login();
      const prof = await liff.getProfile(); liffProfile=prof; userId=prof.userId;
      const init = await apiGet({ action:'getorinit', uid:userId });
      if (!init.ok) throw new Error(init.error||'init error');
      if (init.registered){
        boundCID = init.profile.cid;
        $('#hero-avatar').src = init.profile.linepic || prof.pictureUrl || '';
        await renderHome(boundCID);
      } else {
        hide('#loader'); show('#view-register');
        $('#reg-avatar').src = prof.pictureUrl || ''; $('#reg-name').textContent = prof.displayName || '-';
      }
    }catch(err){ hide('#loader'); Swal.fire({ icon:'error', title:'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message }); }
  }

  // Register
  $('#btn-register')?.addEventListener('click', async ()=>{
    const cid = onlyDigit($('#cid').value);
    if (!okCID(cid)) return Swal.fire({ icon:'warning', title:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ 13 ‡∏´‡∏•‡∏±‡∏Å' });
    const rs = await apiPost({ action:'register', cid, uid:userId, linename:liffProfile?.displayName||'', linepic:liffProfile?.pictureUrl||'' });
    if(!rs.ok) return Swal.fire({ icon:'error', title:'‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: rs.error||'' });
    boundCID=cid; Swal.fire({ icon:'success', title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text:'‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' });
    await renderHome(boundCID);
  });

  // Search by month (optional UX)
  $('#btn-search')?.addEventListener('click', ()=>{
    const val = $('#month-select').value;
    if(!val){ $('#cards').innerHTML = monthsCache.map(cardTemplate).join(''); return; }
    const pick = monthsCache.filter(m=>m.month===val);
    $('#cards').innerHTML = (pick.length?pick:monthsCache).map(cardTemplate).join('');
  });

  // FAB refresh
  async function refreshData(){
    if (refreshing) return; const now=Date.now(); if (now-lastRefreshAt<1200) return; lastRefreshAt=now;
    try{ setRefreshBusy(true); boundCID ? (await renderHome(boundCID), toastOK()) : await main(); }
    catch(err){ Swal.fire({ icon:'error', title:'‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: err.message }); }
    finally{ setRefreshBusy(false); }
  }
  btnRefresh?.addEventListener('click', refreshData);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && boundCID){ refreshData(); } });

  // Start
  main();
  </script>
</body>
</html>
