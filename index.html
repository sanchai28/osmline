<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SMART CARE – OSM LIFF</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{ background: radial-gradient(80% 60% at 20% 10%, #ff7bd5 0%, #7b61ff 40%, #1abc9c 100%) fixed; }
    .card{ @apply bg-white rounded-3xl shadow-xl; }
    .chip{ @apply text-xs px-2 py-1 rounded-full; }
    .tick{ width: 22px; height: 22px; }
    .safe-area{ padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 safe-area">
  <div id="app" class="w-full max-w-sm">

    <!-- Header -->
    <header class="flex items-center justify-between text-white/95 mb-4">
      <div class="text-lg font-semibold tracking-wide">SMART CARE</div>
      <div id="notifDot" class="w-3 h-3 rounded-full bg-yellow-300 animate-pulse"></div>
    </header>

    <!-- Registration -->
    <section id="view-register" class="card p-5 hidden">
      <div class="flex items-center gap-3">
        <img id="reg-avatar" class="w-12 h-12 rounded-full object-cover" src="" alt="">
        <div class="font-semibold leading-tight">
          <div id="reg-name">-</div>
          <div class="text-xs text-gray-500">ลงทะเบียนใช้งานครั้งแรก</div>
        </div>
      </div>

      <div class="mt-4">
        <label class="block text-sm font-medium mb-1">หมายเลขบัตรประชาชน (13 หลัก)</label>
        <input id="cid" inputmode="numeric" maxlength="13"
               class="w-full rounded-2xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500"
               placeholder="กรอกเลขบัตรประชาชน" />
        <p class="text-xs text-gray-500 mt-1">* ใช้สำหรับจับคู่ข้อมูลกับระบบ อสม.</p>
      </div>

      <button id="btn-register"
              class="mt-4 w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-2xl active:scale-[0.99]">
        ยืนยันลงทะเบียน
      </button>
    </section>

    <!-- Home -->
    <section id="view-home" class="hidden">
      <!-- Profile Card -->
      <div class="card p-5">
        <div class="flex items-center gap-3">
          <img id="pfp" class="w-14 h-14 rounded-2xl object-cover" src="" alt="">
          <div class="grow">
            <div id="pf-name" class="font-semibold text-lg leading-tight">-</div>
            <div class="text-sm text-gray-500">
              <span id="pf-cid">-</span> · หมู่ <span id="pf-moo">-</span>
            </div>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-3">
          <a class="card p-3 flex gap-3 items-center">
            <div class="shrink-0 w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center">
              <!-- bell -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.25 18.25h-4.5m8.25-6A5.25 5.25 0 0 0 6.75 12.25v1.144c0 .764-.293 1.497-.818 2.047L4.5 16.75h15l-1.432-1.309a2.99 2.99 0 0 1-.818-2.047v-1.144z"/></svg>
            </div>
            <div class="text-sm">
              <div class="font-semibold">ระบบการแจ้งเตือน</div>
              <div class="text-gray-500">ติดตามงาน อสม.</div>
            </div>
          </a>
          <a class="card p-3 flex gap-3 items-center">
            <div class="shrink-0 w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center">
              <!-- doc -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m-7.5-12h6.75L18 8.25V19.5A1.5 1.5 0 0 1 16.5 21h-9A1.5 1.5 0 0 1 6 19.5V6A1.5 1.5 0 0 1 7.5 4.5z"/></svg>
            </div>
            <div class="text-sm">
              <div class="font-semibold">ประวัติการทำงาน</div>
              <div class="text-gray-500">บันทึก/ตรวจสอบ</div>
            </div>
          </a>
        </div>
      </div>

      <!-- Monthly Status -->
      <div class="mt-4 card p-5">
        <div class="flex items-center justify-between">
          <div class="font-semibold">สถานะการส่งแผน (รายเดือน)</div>
          <span class="chip bg-gray-100">ปีงบประมาณ</span>
        </div>

        <div id="month-list" class="mt-3 divide-y">
          <!-- rows injected -->
        </div>
      </div>

      <div class="h-8"></div>
    </section>

    <!-- Loader -->
    <div id="loader" class="flex items-center justify-center text-white mt-10">
      <svg class="animate-spin h-6 w-6 mr-2" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle>
        <path class="opacity-75" fill="white" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <span>กำลังโหลด…</span>
    </div>

  </div>

<script>
/* ===== Config (ใส่ค่าจริง) ===== */
const LIFF_ID  = '2008189191-jnqX2z8B';
const API_BASE = 'https://script.google.com/macros/s/AKfycbyOs1VkVy2FaqrWS_bMg8tr89VtiZkmaPvRt8h1WesrLev6R_V7uLcdy9EocE9oHAKW/exec';

/* ===== Utilities ===== */
const $ = s => document.querySelector(s);
const show = id => { $(id).classList.remove('hidden'); };
const hide = id => { $(id).classList.add('hidden'); };

const MONTHS = ['ตุลาคม','พฤศจิกายน','ธันวาคม','มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน'];

function checkCID(x){ return /^\d{13}$/.test(String(x||'').trim()); }

function rowTemplate(r){
  // plan tick
  const tick = r.tick
    ? `<svg class="tick text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>`
    : `<svg class="tick text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg>`;

  let chipCls = 'bg-gray-100 text-gray-600', chipTxt = 'รอตรวจสอบ';
  if (r.reportState === 'ok') { chipCls = 'bg-emerald-100 text-emerald-700'; chipTxt = 'ส่งรายงาน อสม.1 ถูกต้อง'; }
  else if (r.reportState === 'bad') { chipCls = 'bg-rose-100 text-rose-700'; chipTxt = 'ยังไม่ถูกต้อง'; }

  const planText = r.planStatus || 'ยังไม่ได้ส่ง';
  const planCls  = r.tick ? 'text-emerald-700' : 'text-amber-600';

  return `
  <div class="py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      ${tick}
      <div>
        <div class="font-medium">${r.month}</div>
        <div class="text-xs ${planCls}">สถานะ: ${planText}</div>
      </div>
    </div>
    <div class="chip ${chipCls}">${chipTxt}</div>
  </div>`;
}

async function apiGet(params){
  const url = new URL(API_BASE);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  const res = await fetch(url.toString(), { method:'GET' });
  return res.json();
}
async function apiPost(body){
  const res = await fetch(API_BASE, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  return res.json();
}

/* ===== App Flow ===== */
let liffProfile = null;
let userId = '';
let boundCID = '';

async function main(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();

    const prof = await liff.getProfile();
    liffProfile = prof;
    userId = prof.userId;

    // ตรวจว่าลงทะเบียนแล้วหรือยัง
    const init = await apiGet({ action:'getorinit', uid:userId });
    if (!init.ok) throw new Error(init.error || 'init error');

    if (init.registered){
      // มีข้อมูลแล้ว → โหลดสถานะ
      boundCID = init.profile.cid;
      await renderHome(boundCID, init.profile);
    } else {
      // ยังไม่เคย → แสดงหน้า register
      $('#reg-avatar').src = prof.pictureUrl || '';
      $('#reg-name').textContent = prof.displayName || '-';
      hide('#loader'); show('#view-register');
    }
  }catch(err){
    hide('#loader');
    alert('เกิดข้อผิดพลาด: ' + err.message);
  }
}

async function renderHome(cid, infoFromInit=null){
  hide('#loader');

  // โหลดสถานะ
  const st = await apiGet({ action:'status', cid });
  if (!st.ok) { alert(st.error || 'โหลดสถานะไม่สำเร็จ'); return; }

  const info = st.info || infoFromInit || {};
  $('#pfp').src = (info.linepic || liffProfile?.pictureUrl || '');
  $('#pf-name').textContent = info.name || liffProfile?.displayName || '-';
  $('#pf-cid').textContent = cid;
  $('#pf-moo').textContent = info.moo || '-';

  $('#month-list').innerHTML = st.months.map(rowTemplate).join('');
  show('#view-home');
}

// Register button
$('#btn-register').addEventListener('click', async () => {
  const cid = $('#cid').value.trim();
  if (!checkCID(cid)) { alert('กรุณากรอกเลขบัตรประชาชน 13 หลักให้ถูกต้อง'); return; }

  hide('#btn-register'); // ป้องกันกดซ้ำ

  const payload = {
    action:'register',
    cid,
    uid: userId,
    linename: liffProfile?.displayName || '',
    linepic:  liffProfile?.pictureUrl || ''
  };
  const rs = await apiPost(payload);
  if (!rs.ok) { alert(rs.error || 'ลงทะเบียนไม่สำเร็จ'); show('#btn-register'); return; }

  boundCID = cid;
  // ไปหน้าหลักทันที
  await renderHome(boundCID);
});

main();
</script>
</body>
</html>
