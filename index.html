<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>OSM LIFF – Smart Care</title>

<!-- LIFF + Tailwind + SweetAlert2 -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  /* พื้นหลังไล่สี */
  body{ background: radial-gradient(120% 140% at 0% 0%, #C084FC 0%, #A78BFA 30%, #8B5CF6 55%, #F472B6 90%) fixed; }
  .safe-area{ padding-bottom: env(safe-area-inset-bottom); }

  /* การ์ดกลาส + นีโอ */
  .glass{ background: rgba(255,255,255,.78); backdrop-filter: blur(16px); }
  .neo{ box-shadow: 10px 12px 28px rgba(31,41,55,.18), -6px -6px 18px rgba(255,255,255,.4); }

  /* การ์ดเดือน */
  .month-card{
    border-radius: 22px; padding: 14px; background: rgba(255,255,255,.9);
    box-shadow: 0 10px 22px rgba(168,85,247,.18);
  }
  .month-badge{
    display:inline-flex; align-items:center; gap:8px;
    font-weight:800; font-size:18px; color:#4c1d95;
    background: linear-gradient(135deg,#ede9fe,#ffe4f0); padding:8px 12px; border-radius:14px;
  }
  .tick{ width:26px; height:26px }
  .chip{ display:inline-block; min-width: 128px; text-align:center; padding:10px 12px; border-radius:9999px; font-weight:700; font-size:15px; white-space:nowrap; }
  .chip-plan-ok{   background:#D1FAE5; color:#065F46; }
  .chip-plan-warn{ background:#FEF3C7; color:#92400E; }
  .chip-check-ok{  background:#D1FAE5; color:#065F46; }
  .chip-check-bad{ background:#FEE2E2; color:#991B1B; }
  .chip-check-wait{background:#E5E7EB; color:#374151; }

  /* กริดการ์ด: มือถือ = 1 คอลัมน์, จอกว้างขึ้น = 2 */
  .cards{ display:grid; grid-template-columns: 1fr; gap:14px; }
  @media (min-width: 430px){ .cards{ grid-template-columns: 1fr 1fr; } }

  /* ตัวหนังสือใหญ่สบายตา */
  .big { font-size: clamp(16px, 3.8vw, 18px); }
  .bigger { font-size: clamp(18px, 4.2vw, 20px); }
</style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 safe-area">
  <div class="w-full max-w-md">

    <!-- Header -->
    <header class="text-white flex items-center justify-between">
      <div class="text-2xl font-semibold tracking-wide">Smart Care</div>
      <div class="w-9 h-9 rounded-full bg-white/25 flex items-center justify-center">
        <svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" fill="none" class="opacity-90">
          <path stroke-linecap="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01"/>
        </svg>
      </div>
    </header>

    <!-- Hero -->
    <section class="glass neo rounded-3xl mt-4 p-5 text-slate-800">
      <div class="flex items-center gap-4">
        <img id="hero-avatar" class="w-14 h-14 rounded-2xl object-cover" src="" alt="">
        <div class="leading-tight">
          <div class="text-slate-600 big">สวัสดี</div>
          <div id="hero-name" class="bigger font-semibold">-</div>
        </div>
      </div>
      <div class="mt-4 rounded-2xl p-4 text-white"
           style="background: linear-gradient(135deg,#A78BFA 0%,#F472B6 100%); box-shadow:0 10px 22px rgba(168,85,247,.35);">
        <div class="opacity-90 big">เลขบัตรประชาชน</div>
        <div id="hero-cid" class="text-2xl font-extrabold tracking-wide">-</div>
        <div class="mt-1 opacity-90 big">หมู่บ้าน <span id="hero-moo">-</span></div>
      </div>
    </section>

    <!-- การ์ดแยกเดือน -->
    <section class="mt-4">
      <div id="cards" class="cards"></div>
    </section>

    <!-- Register (ครั้งแรก) -->
    <section id="view-register" class="glass neo rounded-3xl mt-4 p-5 hidden">
      <div class="flex items-center gap-3">
        <img id="reg-avatar" class="w-12 h-12 rounded-2xl object-cover" src="" alt="">
        <div class="leading-tight">
          <div class="text-slate-600 big">ลงทะเบียนใช้งานครั้งแรก</div>
          <div id="reg-name" class="bigger font-semibold">-</div>
        </div>
      </div>
      <label class="block font-medium mt-4 mb-2 text-slate-700 big">หมายเลขบัตรประชาชน (13 หลัก)</label>
      <input id="cid" inputmode="numeric" maxlength="13"
             class="w-full rounded-2xl px-4 py-3 outline-none ring-2 ring-transparent focus:ring-violet-400 bg-white big"
             placeholder="กรอกเลขบัตรประชาชน">
      <button id="btn-register"
        class="mt-4 w-full rounded-2xl py-3 font-bold text-white big"
        style="background: linear-gradient(135deg,#A78BFA 0%,#F472B6 100%); box-shadow:0 12px 26px rgba(168,85,247,.35);">
        ยืนยันลงทะเบียน
      </button>
    </section>

    <!-- Loader -->
    <div id="loader" class="flex items-center justify-center text-white mt-10 big">
      <svg class="animate-spin h-7 w-7 mr-2" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle>
        <path class="opacity-75" fill="white" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <span>กำลังโหลด…</span>
    </div>

  </div>

<script>
/* ===== Config ===== */
const LIFF_ID  = '2008189191-jnqX2z8B';
const API_BASE = 'https://script.google.com/macros/s/AKfycbxzSdlRAmekNHmt8AkyyO09lv7Xa-cWl_7oyd3P7ng3ybcaOeEsqOo95yPw9IIThR8j/exec';


/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const show = el => $(el).classList.remove('hidden');
const hide = el => $(el).classList.add('hidden');
const onlyDigit = s => String(s||'').replace(/[^\d]/g,'');
const okCID = s => onlyDigit(s).length===13;

function tick(on){
  return on
    ? `<svg class="tick text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>`
    : `<svg class="tick text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg>`;
}

/* การ์ดเดือน */
function cardTemplate(r){
  const planTxt = r.planStatus || 'ยังไม่ได้ส่ง';
  const planCls = r.tick ? 'chip-plan-ok' : 'chip-plan-warn';
  let chkTxt='รอตรวจสอบ', chkCls='chip-check-wait';
  if (r.reportState==='ok'){ chkTxt='ถูกต้อง'; chkCls='chip-check-ok'; }
  else if (r.reportState==='bad'){ chkTxt='ไม่ถูกต้อง'; chkCls='chip-check-bad'; }

  return `
    <div class="month-card">
      <div class="flex items-center justify-between">
        <div class="month-badge">${tick(r.tick)} <span>${r.month}</span></div>
      </div>
      <div class="mt-3 grid grid-cols-1 gap-2">
        <div class="flex items-center justify-between">
          <div class="text-slate-500 big">สถานะส่งแผน</div>
          <span class="chip ${planCls}">${planTxt}</span>
        </div>
        <div class="flex items-center justify-between">
          <div class="text-slate-500 big">รายงาน-อสม.1</div>
          <span class="chip ${chkCls}">${chkTxt}</span>
        </div>
      </div>
    </div>
  `;
}

/* ===== API (simple request → เลี่ยง CORS) ===== */
async function apiGet(params){
  const url = new URL(API_BASE);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k, v));
  const res = await fetch(url.toString(), { method:'GET' });
  return res.json();
}
async function apiPost(body){
  const res = await fetch(API_BASE, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify(body)
  });
  return res.json();
}

/* ===== App Flow ===== */
let liffProfile=null, userId='', boundCID='';
let monthsCache=[];

function loading(title='กำลังประมวลผล'){
  Swal.fire({title, allowOutsideClick:false, allowEscapeKey:false, didOpen:()=>Swal.showLoading()});
}

async function main(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();

    const prof = await liff.getProfile();
    liffProfile = prof; userId = prof.userId;

    const init = await apiGet({ action:'getorinit', uid:userId });
    if (!init.ok) throw new Error(init.error||'init error');

    if (init.registered){
      boundCID = init.profile.cid;
      $('#hero-avatar').src = init.profile.linepic || prof.pictureUrl || '';
      $('#hero-name').textContent = init.profile.linename || prof.displayName || '-';
      await renderHome(boundCID);
    }else{
      hide('#loader'); show('#view-register');
      $('#reg-avatar').src = prof.pictureUrl || '';
      $('#reg-name').textContent = prof.displayName || '-';
    }
  }catch(err){
    hide('#loader'); Swal.fire('เกิดข้อผิดพลาด', err.message, 'error');
  }
}

async function renderHome(cid){
  loading('กำลังโหลดข้อมูล…');
  const st = await apiGet({ action:'status', cid });
  Swal.close();

  if (!st.ok){ Swal.fire('โหลดข้อมูลไม่สำเร็จ', st.error||'', 'error'); return; }

  monthsCache = st.months || [];
  $('#hero-name').textContent = st.info?.linename || liffProfile?.displayName || '-';
  $('#hero-avatar').src = st.info?.linepic || liffProfile?.pictureUrl || '';
  $('#hero-cid').textContent = cid;
  $('#hero-moo').textContent = st.info?.moo || '-';

  hide('#loader');
  $('#cards').innerHTML = monthsCache.map(cardTemplate).join('');
}

/* ลงทะเบียนครั้งแรก */
$('#btn-register').addEventListener('click', async ()=>{
  const cid = onlyDigit($('#cid').value);
  if (!okCID(cid)){ Swal.fire('ข้อมูลไม่ถูกต้อง','กรุณากรอกเลขบัตร 13 หลัก','warning'); return; }
  loading('กำลังลงทะเบียน…');
  const rs = await apiPost({
    action:'register',
    cid,
    uid: userId,
    linename: liffProfile?.displayName || '',
    linepic:  liffProfile?.pictureUrl || ''
  });
  Swal.close();
  if (!rs.ok){ Swal.fire('ลงทะเบียนไม่สำเร็จ', rs.error||'', 'error'); return; }
  boundCID = cid;
  Swal.fire('สำเร็จ','ลงทะเบียนเรียบร้อย','success');
  await renderHome(boundCID);
});

main();
</script>
</body>
</html>
