<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <title>อสม.โคกเจริญ</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* Minimal Gradient Background */
    body{
      background: linear-gradient(135deg, #f5f7fa 0%, #e8edf2 100%) fixed;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .safe-area{ padding-bottom: env(safe-area-inset-bottom); }

    html{
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      --a11y-scale: 1;
      font-size: calc(16px * var(--a11y-scale));
    }

    /* Modern Card Style */
    .card-base{
      background: white;
      border-radius: 1.25rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
      transition: all 0.3s ease;
    }
    .card-base:hover{
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }

    /* Hero Card */
    .hero-card{
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      padding: 1.75rem;
    }

    /* ID Card Section */
    .id-section{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 1.25rem;
      padding: 1.5rem;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.25);
    }

    /* Month Card */
    .month-card{
      background: white;
      border-radius: 1.125rem;
      padding: 1.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.04);
      transition: all 0.3s ease;
    }
    .month-card:hover{
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }

    .month-badge{
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      font-size: 1.0625rem;
      color: #1e293b;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      padding: 0.5rem 0.875rem;
      border-radius: 0.75rem;
    }

    .tick{ 
      width: 1.375rem; 
      height: 1.375rem; 
    }

    /* Minimal Chips */
    .chip{
      display: inline-block;
      min-width: 9ch;
      padding: 0.5rem 0.875rem;
      border-radius: 0.625rem;
      font-weight: 600;
      font-size: 0.875rem;
      line-height: 1;
      white-space: nowrap;
      text-align: center;
      transition: all 0.2s ease;
    }
    .chip-plan-ok{   background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .chip-plan-warn{ background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .chip-check-ok{  background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .chip-check-bad{ background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .chip-check-wait{background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }

    /* Cards Grid */
    .cards{ 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 1rem; 
    }
    @media (min-width: 430px){ 
      .cards{ 
        grid-template-columns: repeat(2, 1fr); 
      } 
    }

    /* Typography */
    .big    { font-size: clamp(0.9375rem, 3.6vw, 1rem); }
    .bigger { font-size: clamp(1.0625rem, 4vw, 1.1875rem); }

    /* Header Buttons */
    .font-btn{
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 0.625rem;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      display: grid;
      place-items: center;
      font-weight: 600;
      font-size: 0.875rem;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.2s ease;
    }
    .font-btn:hover{
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    /* Primary Button */
    .btn-primary{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 0.875rem;
      padding: 0.875rem;
      font-weight: 600;
      color: white;
      box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
    }
    .btn-primary:hover{
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-1px);
    }

    /* Input Field */
    .input-field{
      width: 100%;
      border-radius: 0.875rem;
      padding: 0.875rem 1rem;
      outline: none;
      border: 2px solid #e2e8f0;
      background: white;
      transition: all 0.2s ease;
    }
    .input-field:focus{
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* Note Box */
    .note-box{
      margin-top: 0.75rem;
      padding: 1rem;
      background: #fef2f2;
      border-left: 3px solid #ef4444;
      border-radius: 0.625rem;
    }

    @media (prefers-reduced-motion: reduce){
      * { 
        animation-duration: .01ms !important; 
        animation-iteration-count: 1 !important; 
        transition-duration: .01ms !important; 
      }
    }
  </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 safe-area">
  <div class="w-full max-w-md">

    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div>
        <div class="text-2xl font-bold text-slate-800">อสม.โคกเจริญ</div>
        <div class="text-sm text-slate-600 mt-0.5">ระบบติดตามสถานะรายงาน</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="font-down" class="font-btn" aria-label="ลดขนาดอักษร">A−</button>
        <button id="font-up" class="font-btn" aria-label="เพิ่มขนาดอักษร">A+</button>
      </div>
    </header>

    <!-- Hero -->
    <section class="hero-card">
      <div class="flex items-center gap-3.5">
        <img id="hero-avatar" class="w-14 h-14 rounded-xl object-cover shadow-md" src="" alt="">
        <div class="leading-tight">
          <div class="text-slate-500 text-sm font-medium">สวัสดี</div>
          <div id="hero-name" class="text-lg font-bold text-slate-800 mt-0.5">-</div>
        </div>
      </div>
      <div class="id-section mt-4">
        <div class="text-white/80 text-sm font-medium">เลขบัตรประชาชน</div>
        <div id="hero-cid" class="text-2xl font-bold text-white tracking-wider mt-1">-</div>
        <div class="text-white/80 text-sm font-medium mt-2">
          หมู่บ้าน <span id="hero-moo" class="font-semibold text-white">-</span>
        </div>
      </div>
    </section>

    <!-- Month Cards -->
    <section class="mt-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold text-slate-800">สถานะรายเดือน</h2>
        <div class="text-sm text-slate-500" id="month-count">12 รายการ</div>
      </div>
      <div id="cards" class="cards"></div>
    </section>

    <!-- Register -->
    <section id="view-register" class="hero-card mt-6 hidden">
      <div class="flex items-center gap-3">
        <img id="reg-avatar" class="w-12 h-12 rounded-xl object-cover shadow-md" src="" alt="">
        <div class="leading-tight">
          <div class="text-slate-500 text-sm font-medium">ลงทะเบียนใช้งานครั้งแรก</div>
          <div id="reg-name" class="text-lg font-bold text-slate-800 mt-0.5">-</div>
        </div>
      </div>
      <label class="block font-semibold mt-5 mb-2 text-slate-700 text-sm">
        หมายเลขบัตรประชาชน (13 หลัก)
      </label>
      <input id="cid" inputmode="numeric" maxlength="13"
             class="input-field"
             placeholder="กรอกเลขบัตรประชาชน">
      <button id="btn-register" class="btn-primary w-full mt-4">
        ยืนยันลงทะเบียน
      </button>
    </section>

    <!-- Loader -->
    <div id="loader" class="flex items-center justify-center mt-12">
      <div class="flex items-center gap-3 bg-white px-6 py-4 rounded-xl shadow-lg">
        <svg class="animate-spin h-5 w-5 text-indigo-600" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <span class="text-slate-700 font-medium">กำลังโหลด…</span>
      </div>
    </div>

  </div>

  <script>
  /* ===== Config ===== */
  const LIFF_ID  = '2008189191-jnqX2z8B';
  const API_BASE = 'https://script.google.com/macros/s/AKfycbzvrK6QIFKXXCdHj9KzKi4bBk5bHiHZVidfov2V3xmskZ8yZsnar8TNqEbyQHJ3inos/exec';

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const show = el => $(el).classList.remove('hidden');
  const hide = el => $(el).classList.add('hidden');
  const onlyDigit = s => String(s||'').replace(/[^\d]/g,'');
  const okCID = s => onlyDigit(s).length===13;

  function tick(on){
    return on
      ? `<svg class="tick text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 13l4 4L19 7"/></svg>`
      : `<svg class="tick text-slate-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg>`;
  }

  function cardTemplate(r){
    const planTxt = r.planStatus || 'ยังไม่ได้ส่ง';
    const planCls = r.tick ? 'chip-plan-ok' : 'chip-plan-warn';

    let chkTxt='รอตรวจสอบ', chkCls='chip-check-wait', noteHtml='';
    const isBad = (r.reportState === 'bad') || /ไม่ผ่าน/.test(r.checkStatus || '');
    if (!isBad && r.reportState === 'ok'){ chkTxt='ถูกต้อง'; chkCls='chip-check-ok'; }
    else if (isBad){
      chkTxt='ไม่ถูกต้อง'; chkCls='chip-check-bad';
      if (r.note && String(r.note).trim()){
        const formattedNote = String(r.note)
          .replace(/•/g, '\n•')
          .replace(/^\n/, '')
          .trim();
        noteHtml = `<div class="note-box">
          <div class="font-semibold text-rose-900 text-sm mb-1.5">หมายเหตุ:</div>
          <div class="text-sm text-rose-700 leading-relaxed whitespace-pre-line">${formattedNote}</div>
        </div>`;
      }
    }

    return `
      <div class="month-card">
        <div class="flex items-center justify-between mb-3">
          <div class="month-badge">${tick(r.tick)} <span>${r.month}</span></div>
        </div>
        <div class="space-y-2.5">
          <div class="flex items-center justify-between">
            <div class="text-slate-600 text-sm font-medium">สถานะส่งแผน</div>
            <span class="chip ${planCls}">${planTxt}</span>
          </div>
          <div>
            <div class="flex items-center justify-between">
              <div class="text-slate-600 text-sm font-medium">รายงาน-อสม.1</div>
              <span class="chip ${chkCls}">${chkTxt}</span>
            </div>
            ${noteHtml}
          </div>
        </div>
      </div>
    `;
  }

  /* ===== API ===== */
  async function apiGet(params){
    const url = new URL(API_BASE);
    Object.entries(params).forEach(([k,v])=>url.searchParams.set(k, v));
    const res = await fetch(url.toString(), { method:'GET' });
    return res.json();
  }
  async function apiPost(body){
    const res = await fetch(API_BASE, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });
    return res.json();
  }

  /* ===== Font Scale ===== */
  const SCALE_KEY = 'osm_a11y_scale';
  function applyScale(v){
    const val = Math.min(1.6, Math.max(0.9, v));
    document.documentElement.style.setProperty('--a11y-scale', String(val));
    localStorage.setItem(SCALE_KEY, String(val));
  }
  function loadScale(){
    const saved = parseFloat(localStorage.getItem(SCALE_KEY) || '1');
    applyScale(isNaN(saved) ? 1 : saved);
  }
  $('#font-down')?.addEventListener('click', ()=>{
    const cur = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--a11y-scale')) || 1;
    applyScale(cur - 0.1);
  });
  $('#font-up')?.addEventListener('click', ()=>{
    const cur = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--a11y-scale')) || 1;
    applyScale(cur + 0.1);
  });

  /* ===== App Flow ===== */
  let liffProfile=null, userId='', boundCID='';
  let monthsCache=[];

  function loading(title='กำลังประมวลผล'){
    Swal.fire({
      title, 
      allowOutsideClick:false, 
      allowEscapeKey:false, 
      didOpen:()=>Swal.showLoading()
    });
  }

  async function main(){
    try{
      loadScale();

      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) liff.login();

      const prof = await liff.getProfile();
      liffProfile = prof; userId = prof.userId;

      const init = await apiGet({ action:'getorinit', uid:userId });
      if (!init.ok) throw new Error(init.error||'init error');

      if (init.registered){
        boundCID = init.profile.cid;
        $('#hero-avatar').src = init.profile.linepic || prof.pictureUrl || '';
        $('#hero-name').textContent = init.profile.linename || prof.displayName || '-';
        await renderHome(boundCID);
      }else{
        hide('#loader');
        show('#view-register');
        $('#reg-avatar').src = prof.pictureUrl || '';
        $('#reg-name').textContent = prof.displayName || '-';
      }
    }catch(err){
      hide('#loader'); 
      Swal.fire('เกิดข้อผิดพลาด', err.message, 'error');
    }
  }

  async function renderHome(cid){
    loading('กำลังโหลดข้อมูล…');
    const st = await apiGet({ action:'status', cid });
    Swal.close();

    if (!st.ok){ 
      Swal.fire('โหลดข้อมูลไม่สำเร็จ', st.error||'', 'error'); 
      return; 
    }

    monthsCache = st.months || [];
    $('#hero-name').textContent = st.info?.linename || liffProfile?.displayName || '-';
    $('#hero-avatar').src = st.info?.linepic || liffProfile?.pictureUrl || '';
    $('#hero-cid').textContent = cid;
    $('#hero-moo').textContent = st.info?.moo || '-';

    hide('#loader');
    $('#cards').innerHTML = monthsCache.map(cardTemplate).join('');
    $('#month-count').textContent = `${monthsCache.length} รายการ`;
  }

  $('#btn-register')?.addEventListener('click', async ()=>{
    const cid = onlyDigit($('#cid').value);
    if (!okCID(cid)){ 
      Swal.fire('ข้อมูลไม่ถูกต้อง','กรุณากรอกเลขบัตร 13 หลัก','warning'); 
      return; 
    }
    loading('กำลังลงทะเบียน…');
    const rs = await apiPost({
      action:'register',
      cid,
      uid: userId,
      linename: liffProfile?.displayName || '',
      linepic:  liffProfile?.pictureUrl || ''
    });
    Swal.close();
    if (!rs.ok){ 
      Swal.fire('ลงทะเบียนไม่สำเร็จ', rs.error||'', 'error'); 
      return; 
    }
    boundCID = cid;
    Swal.fire('สำเร็จ','ลงทะเบียนเรียบร้อย','success');
    await renderHome(boundCID);
  });

  main();
  </script>
</body>
</html>
