<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>OSM LIFF – Smart Care</title>

<!-- LIFF + Tailwind + SweetAlert2 -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  body{
    background: radial-gradient(120% 140% at 0% 0%, #C084FC 0%, #A78BFA 30%, #8B5CF6 55%, #F472B6 90%) fixed;
  }
  .neo{ box-shadow: 8px 8px 20px rgba(31,41,55,.18), -8px -8px 20px rgba(255,255,255,.35); }
  .glass{ background: rgba(255,255,255,.72); backdrop-filter: blur(14px); }
  .tick{ width:22px;height:22px }
  .chip{ padding:.35rem .6rem; border-radius:9999px; font-size:.72rem; font-weight:600; white-space:nowrap; }
  .safe-area{ padding-bottom: env(safe-area-inset-bottom) }
</style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 safe-area">
  <div class="w-full max-w-sm">

    <!-- Top bar -->
    <header class="text-white flex items-center justify-between">
      <div class="text-xl font-semibold tracking-wide">Smart Care</div>
      <div class="w-8 h-8 rounded-full bg-white/25 flex items-center justify-center">
        <svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" fill="none" class="opacity-90">
          <path stroke-linecap="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01"/>
        </svg>
      </div>
    </header>

    <!-- Hero -->
    <section class="glass neo rounded-3xl mt-4 p-5 text-slate-800">
      <div class="flex items-center gap-3">
        <img id="hero-avatar" class="w-12 h-12 rounded-2xl object-cover" src="" alt="">
        <div class="leading-tight">
          <div class="text-sm text-slate-500">สวัสดี</div>
          <div id="hero-name" class="font-semibold text-lg">-</div>
        </div>
      </div>
      <div class="mt-4 rounded-2xl p-4 text-white"
           style="background: linear-gradient(135deg,#A78BFA 0%,#F472B6 100%); box-shadow:0 8px 18px rgba(168,85,247,.35);">
        <div class="text-xs/relaxed opacity-90">เลขบัตรประชาชน</div>
        <div id="hero-cid" class="text-xl font-bold tracking-wide">-</div>
        <div class="text-xs mt-1 opacity-90">หมู่บ้าน <span id="hero-moo">-</span></div>
      </div>
    </section>

    <!-- Combined Status List -->
    <section class="glass neo rounded-3xl mt-4 p-4">
      <!-- header row -->
      <div class="bg-white/70 rounded-xl px-3 py-2 text-[11px] font-semibold text-slate-600 grid"
           style="grid-template-columns: 1fr 1fr 1fr;">
        <div>เดือน</div>
        <div class="text-center">สถานะ</div>
        <div class="text-right">รายงาน-อสม.1</div>
      </div>
      <div id="month-list" class="mt-2 divide-y"></div>
    </section>

    <!-- Register (first time) -->
    <section id="view-register" class="glass neo rounded-3xl mt-4 p-5 hidden">
      <div class="flex items-center gap-3">
        <img id="reg-avatar" class="w-12 h-12 rounded-2xl object-cover" src="" alt="">
        <div class="leading-tight">
          <div class="text-xs text-slate-500">ลงทะเบียนใช้งานครั้งแรก</div>
          <div id="reg-name" class="font-semibold text-lg">-</div>
        </div>
      </div>
      <label class="block text-sm font-medium mt-4 mb-1 text-slate-700">หมายเลขบัตรประชาชน (13 หลัก)</label>
      <input id="cid" inputmode="numeric" maxlength="13"
             class="w-full rounded-2xl px-4 py-3 outline-none ring-2 ring-transparent focus:ring-violet-400 bg-white"
             placeholder="กรอกเลขบัตรประชาชน">
      <button id="btn-register"
        class="mt-4 w-full rounded-2xl py-3 font-semibold text-white"
        style="background: linear-gradient(135deg,#A78BFA 0%,#F472B6 100%); box-shadow:0 10px 22px rgba(168,85,247,.35);">
        ยืนยันลงทะเบียน
      </button>
    </section>

    <!-- Loader -->
    <div id="loader" class="flex items-center justify-center text-white mt-10">
      <svg class="animate-spin h-6 w-6 mr-2" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle>
        <path class="opacity-75" fill="white" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <span>กำลังโหลด…</span>
    </div>

  </div>

<script>
/* ===== Config ===== */
const LIFF_ID  = '2008189191-jnqX2z8B';
const API_BASE = 'https://script.google.com/macros/s/AKfycbxzSdlRAmekNHmt8AkyyO09lv7Xa-cWl_7oyd3P7ng3ybcaOeEsqOo95yPw9IIThR8j/exec';


/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const show = el => $(el).classList.remove('hidden');
const hide = el => $(el).classList.add('hidden');
const onlyDigit = s => String(s||'').replace(/[^\d]/g,'');
const okCID = s => onlyDigit(s).length===13;

function tick(on){
  return on
    ? `<svg class="tick text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>`
    : `<svg class="tick text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg>`;
}
function chip(txt, cls){ return `<span class="chip ${cls}">${txt}</span>`; }

/* เดือนรวมสถานะ + ผลตรวจสอบ (แถวเดียว) */
function rowCombined(r){
  // คอลัมน์กลาง = สถานะส่งแผน (+ติ๊ก)
  const planTxt = r.planStatus || 'ยังไม่ได้ส่ง';
  const planCls = r.tick ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700';
  // คอลัมน์ขวา = ผลตรวจสอบ อสม.1
  let chkTxt = 'รอตรวจสอบ', chkCls = 'bg-gray-100 text-gray-600';
  if (r.reportState==='ok'){ chkTxt = 'ถูกต้อง'; chkCls = 'bg-emerald-100 text-emerald-700'; }
  else if (r.reportState==='bad'){ chkTxt = 'ไม่ถูกต้อง'; chkCls = 'bg-rose-100 text-rose-700'; }

  return `
    <div class="py-3 grid items-center gap-2" style="grid-template-columns: 1fr 1fr 1fr;">
      <div class="flex items-center gap-3">
        ${tick(r.tick)}
        <div class="font-medium">${r.month}</div>
      </div>
      <div class="text-center">${chip(planTxt, planCls)}</div>
      <div class="text-right">${chip('รายงาน-อสม.1: '+chkTxt, chkCls)}</div>
    </div>
  `;
}

/* ===== API (simple request → เลี่ยง CORS) ===== */
async function apiGet(params){
  const url = new URL(API_BASE);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k, v));
  const res = await fetch(url.toString(), { method:'GET' });
  return res.json();
}
async function apiPost(body){
  const res = await fetch(API_BASE, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // simple request (no preflight)
    body: JSON.stringify(body)
  });
  return res.json();
}

/* ===== App State & Flow ===== */
let liffProfile=null, userId='', boundCID='';
let monthsCache=[];

function loading(title='กำลังประมวลผล'){
  Swal.fire({title, allowOutsideClick:false, allowEscapeKey:false, didOpen:()=>Swal.showLoading()});
}

async function main(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();

    const prof = await liff.getProfile();
    liffProfile = prof; userId = prof.userId;

    const init = await apiGet({ action:'getorinit', uid:userId });
    if (!init.ok) throw new Error(init.error||'init error');

    if (init.registered){
      boundCID = init.profile.cid;
      $('#hero-avatar').src = init.profile.linepic || prof.pictureUrl || '';
      $('#hero-name').textContent = init.profile.linename || prof.displayName || '-';
      await renderHome(boundCID);
    }else{
      hide('#loader'); show('#view-register');
      $('#reg-avatar').src = prof.pictureUrl || '';
      $('#reg-name').textContent = prof.displayName || '-';
    }
  }catch(err){
    hide('#loader'); Swal.fire('เกิดข้อผิดพลาด', err.message, 'error');
  }
}

async function renderHome(cid){
  loading('กำลังโหลดข้อมูล…');
  const st = await apiGet({ action:'status', cid });
  Swal.close();

  if (!st.ok){ Swal.fire('โหลดข้อมูลไม่สำเร็จ', st.error||'', 'error'); return; }

  monthsCache = st.months || [];
  $('#hero-name').textContent = st.info?.linename || liffProfile?.displayName || '-';
  $('#hero-avatar').src = st.info?.linepic || liffProfile?.pictureUrl || '';
  $('#hero-cid').textContent = cid;
  $('#hero-moo').textContent = st.info?.moo || '-';

  hide('#loader');
  $('#month-list').innerHTML = monthsCache.map(rowCombined).join('');
}

/* first-time register */
$('#btn-register').addEventListener('click', async ()=>{
  const cid = onlyDigit($('#cid').value);
  if (!okCID(cid)){ Swal.fire('ข้อมูลไม่ถูกต้อง','กรุณากรอกเลขบัตร 13 หลัก','warning'); return; }
  loading('กำลังลงทะเบียน…');
  const rs = await apiPost({
    action:'register',
    cid,
    uid: userId,
    linename: liffProfile?.displayName || '',
    linepic:  liffProfile?.pictureUrl || ''
  });
  Swal.close();
  if (!rs.ok){ Swal.fire('ลงทะเบียนไม่สำเร็จ', rs.error||'', 'error'); return; }
  boundCID = cid;
  Swal.fire('สำเร็จ','ลงทะเบียนเรียบร้อย','success');
  await renderHome(boundCID);
});

main();
</script>
</body>
</html>
