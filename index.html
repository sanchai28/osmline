<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <title>อสม.โคกเจริญ</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700;800&display=swap');
    
    :root {
      --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --gradient-5: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --a11y-scale: 1.0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      font-size: calc(16px * var(--a11y-scale));
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: #1a202c;
      overflow-x: hidden;
    }

    .safe-area {
      padding-bottom: env(safe-area-inset-bottom, 1rem);
    }

    /* Background particles */
    .bg-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: float 20s infinite ease-in-out;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) translateX(0); }
      33% { transform: translateY(-100px) translateX(50px); }
      66% { transform: translateY(-50px) translateX(-50px); }
    }

    /* Glassmorphism Cards */
    .glass-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .glass-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
    }

    .glass-card-solid {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }

    /* Header gradient card */
    .gradient-header {
      background: var(--gradient-3);
      padding: 1.5rem;
      border-radius: 20px;
      color: white;
      box-shadow: 0 10px 40px rgba(79, 172, 254, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Month badge */
    .month-badge {
      background: var(--gradient-4);
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 16px;
      font-weight: 700;
      font-size: 1.1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 8px 24px rgba(67, 233, 123, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Status chips */
    .chip {
      padding: 0.65rem 1.1rem;
      border-radius: 12px;
      font-weight: 700;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
      min-width: 120px;
      justify-content: center;
    }

    .chip:hover {
      transform: scale(1.05);
    }

    .chip-ok {
      background: rgba(16, 185, 129, 0.2);
      color: #065f46;
      border-color: rgba(16, 185, 129, 0.4);
    }

    .chip-warn {
      background: rgba(251, 191, 36, 0.2);
      color: #92400e;
      border-color: rgba(251, 191, 36, 0.4);
    }

    .chip-bad {
      background: rgba(239, 68, 68, 0.2);
      color: #991b1b;
      border-color: rgba(239, 68, 68, 0.4);
    }

    .chip-wait {
      background: rgba(156, 163, 175, 0.2);
      color: #374151;
      border-color: rgba(156, 163, 175, 0.4);
    }

    /* FAB button */
    .fab {
      position: fixed;
      right: 1.5rem;
      bottom: calc(1.5rem + env(safe-area-inset-bottom, 0));
      z-index: 1000;
    }

    .fab-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--gradient-4);
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 12px 32px rgba(67, 233, 123, 0.4);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .fab-btn:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 16px 48px rgba(67, 233, 123, 0.5);
    }

    .fab-btn:active {
      transform: scale(0.95);
    }

    .fab-btn.spinning {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Input */
    .glass-input {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 1rem 1.25rem;
      font-size: 1.1rem;
      font-weight: 600;
      width: 100%;
      transition: all 0.3s;
    }

    .glass-input:focus {
      outline: none;
      border-color: rgba(79, 172, 254, 0.6);
      box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.1);
      background: rgba(255, 255, 255, 0.95);
    }

    /* Button */
    .btn-gradient {
      background: var(--gradient-3);
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      padding: 1rem 2rem;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 24px rgba(79, 172, 254, 0.3);
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
    }

    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(79, 172, 254, 0.4);
    }

    .btn-gradient:active {
      transform: translateY(0);
    }

    /* Font control buttons */
    .font-btn {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .font-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .font-btn:active {
      transform: scale(0.95);
    }

    /* Avatar */
    .avatar {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      object-fit: cover;
      border: 3px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    /* Status row */
    .status-row {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 1rem;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .status-label {
      font-size: 1rem;
      color: #1f2937;
      font-weight: 600;
      flex: 1;
    }

    /* Note box */
    .note-box {
      background: rgba(254, 226, 226, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 2px solid rgba(248, 113, 113, 0.4);
      border-radius: 14px;
      padding: 1rem;
      margin-top: 0.75rem;
    }

    .note-title {
      color: #b91c1c;
      font-weight: 700;
      font-size: 1.05rem;
      margin-bottom: 0.5rem;
    }

    .note-content {
      color: #991b1b;
      font-size: 0.95rem;
      line-height: 1.6;
      white-space: pre-line;
    }

    /* Info boxes */
    .info-box {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 1rem;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Grid */
    .cards-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.25rem;
    }

    @media (min-width: 768px) {
      .cards-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    .slide-up {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes spinLoader {
      to { transform: rotate(360deg); }
    }

    .spinner {
      animation: spinLoader 1s linear infinite;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Utility */
    .hidden { display: none !important; }

    .text-shadow {
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .container-main {
      position: relative;
      z-index: 10;
      max-width: 900px;
      margin: 0 auto;
      padding: 1.5rem;
      padding-bottom: 7rem;
    }

    @media (max-width: 640px) {
      .container-main {
        padding: 1rem;
        padding-bottom: 6rem;
      }
    }
  </style>
</head>
<body>
  <!-- Background Particles -->
  <div class="bg-particles">
    <div class="particle" style="width: 100px; height: 100px; top: 10%; left: 10%; animation-delay: 0s;"></div>
    <div class="particle" style="width: 60px; height: 60px; top: 20%; right: 15%; animation-delay: 2s;"></div>
    <div class="particle" style="width: 80px; height: 80px; bottom: 30%; left: 20%; animation-delay: 4s;"></div>
    <div class="particle" style="width: 50px; height: 50px; bottom: 20%; right: 25%; animation-delay: 6s;"></div>
  </div>

  <div class="container-main safe-area">
    <!-- Header -->
    <header class="glass-card mb-6 p-4 fade-in">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-xl flex items-center justify-center text-white text-2xl font-bold" style="background: var(--gradient-3);">
            อ
          </div>
          <div>
            <div class="text-white text-xl font-bold text-shadow">อสม.โคกเจริญ</div>
            <div class="text-white text-sm opacity-90">ระบบติดตามงาน</div>
          </div>
        </div>
        
        <div class="flex items-center gap-2">
          <button id="font-down" class="font-btn" aria-label="ลดขนาดตัวอักษร">A−</button>
          <button id="font-up" class="font-btn" aria-label="เพิ่มขนาดตัวอักษร">A+</button>
        </div>
      </div>
    </header>

    <!-- Hero Card -->
    <section id="hero-section" class="glass-card-solid mb-6 p-6 slide-up hidden">
      <div class="gradient-header mb-4">
        <div class="flex items-center gap-4">
          <img id="hero-avatar" class="avatar" src="" alt="รูปโปรไฟล์">
          <div>
            <div class="text-sm opacity-90">สวัสดี</div>
            <div id="hero-name" class="text-2xl font-bold">-</div>
          </div>
        </div>
      </div>
      
      <div class="space-y-3">
        <div class="info-box">
          <svg class="w-6 h-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"/>
          </svg>
          <div class="flex-1">
            <div class="text-sm text-gray-600 font-semibold">เลขบัตรประชาชน</div>
            <div id="hero-cid" class="text-lg font-bold text-gray-800 tracking-wider">-</div>
          </div>
        </div>
        
        <div class="info-box">
          <svg class="w-6 h-6 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
          <div>
            <div class="text-sm text-gray-600 font-semibold">หมู่บ้าน</div>
            <div id="hero-moo" class="text-lg font-bold text-gray-800">-</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Monthly Reports -->
    <section id="reports-section" class="hidden">
      <div class="mb-4">
        <h2 class="text-white text-2xl font-bold flex items-center gap-2 text-shadow">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          รายงานประจำเดือน
        </h2>
      </div>
      <div id="cards" class="cards-grid"></div>
    </section>

    <!-- Register View -->
    <section id="view-register" class="glass-card-solid p-6 hidden slide-up">
      <div class="gradient-header mb-6">
        <div class="flex items-center gap-4">
          <img id="reg-avatar" class="avatar" src="" alt="รูปโปรไฟล์">
          <div>
            <div class="text-sm opacity-90">ลงทะเบียนครั้งแรก</div>
            <div id="reg-name" class="text-xl font-bold">-</div>
          </div>
        </div>
      </div>
      
      <label class="block font-bold text-gray-700 mb-3 text-lg">
        หมายเลขบัตรประชาชน (13 หลัก)
      </label>
      <input id="cid" inputmode="numeric" maxlength="13"
             class="glass-input mb-4"
             placeholder="กรอกเลขบัตรประชาชน 13 หลัก">
      <button id="btn-register" class="btn-gradient">
        ยืนยันลงทะเบียน
      </button>
    </section>

    <!-- Loader -->
    <div id="loader" class="flex flex-col items-center justify-center mt-16">
      <div class="glass-card p-8 text-center">
        <svg class="spinner h-12 w-12 text-white mx-auto mb-4" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <span class="text-xl text-white font-semibold text-shadow">กำลังโหลด...</span>
      </div>
    </div>
  </div>

  <!-- FAB -->
  <div class="fab">
    <button id="btn-refresh" class="fab-btn" aria-label="โหลดข้อมูลใหม่">
      <svg id="icon-refresh" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M20 9a8 8 0 10-3.86 7.14"/>
      </svg>
    </button>
  </div>

  <script>
  /* ===== Config ===== */
  const LIFF_ID = '2008189191-jnqX2z8B';
  const API_BASE = 'https://script.google.com/macros/s/AKfycbzvrK6QIFKXXCdHj9KzKi4bBk5bHiHZVidfov2V3xmskZ8yZsnar8TNqEbyQHJ3inos/exec';

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const show = el => $(el)?.classList.remove('hidden');
  const hide = el => $(el)?.classList.add('hidden');
  const onlyDigit = s => String(s||'').replace(/[^\d]/g,'');
  const okCID = s => onlyDigit(s).length === 13;

  function tickIcon(on) {
    if (on) {
      return `<svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
      </svg>`;
    }
    return `<svg class="w-6 h-6 text-white opacity-40" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
    </svg>`;
  }

  function cardTemplate(r) {
    const planTxt = r.planStatus || 'ยังไม่ได้ส่ง';
    const planCls = r.tick ? 'chip-ok' : 'chip-warn';

    let chkTxt = 'รอตรวจสอบ', chkCls = 'chip-wait', noteHtml = '';
    const isBad = (r.reportState === 'bad') || /ไม่ผ่าน/.test(r.checkStatus || '');
    
    if (!isBad && r.reportState === 'ok') {
      chkTxt = 'ถูกต้อง'; 
      chkCls = 'chip-ok';
    } else if (isBad) {
      chkTxt = 'ไม่ถูกต้อง'; 
      chkCls = 'chip-bad';
      
      if (r.note && String(r.note).trim()) {
        const formattedNote = String(r.note).replace(/•/g, '\n•').replace(/^\n/, '').trim();
        noteHtml = `
          <div class="note-box">
            <div class="note-title">📌 หมายเหตุที่ต้องแก้ไข:</div>
            <div class="note-content">${formattedNote}</div>
          </div>
        `;
      }
    }

    return `
      <div class="glass-card-solid p-5 slide-up">
        <div class="month-badge mb-4">
          ${tickIcon(r.tick)}
          <span>${r.month}</span>
        </div>
        
        <div class="space-y-3">
          <div class="status-row">
            <div class="status-label">📋 สถานะส่งแผน</div>
            <span class="chip ${planCls}">${planTxt}</span>
          </div>
          
          <div>
            <div class="status-row">
              <div class="status-label">📊 รายงาน อสม.1</div>
              <span class="chip ${chkCls}">${chkTxt}</span>
            </div>
            ${noteHtml}
          </div>
        </div>
      </div>
    `;
  }

  /* ===== API ===== */
  async function apiGet(params) {
    const url = new URL(API_BASE);
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
    const res = await fetch(url.toString(), { method: 'GET' });
    return res.json();
  }

  async function apiPost(body) {
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });
    return res.json();
  }

  /* ===== Font Scale (in-memory) ===== */
  let fontScale = 1.0;

  function applyScale(val) {
    fontScale = Math.min(1.5, Math.max(0.8, val));
    document.documentElement.style.setProperty('--a11y-scale', String(fontScale));
  }

  $('#font-down')?.addEventListener('click', () => {
    applyScale(fontScale - 0.1);
  });

  $('#font-up')?.addEventListener('click', () => {
    applyScale(fontScale + 0.1);
  });

  /* ===== SweetAlert Helpers ===== */
  function loading(title = 'กำลังประมวลผล') {
    Swal.fire({
      title,
      allowOutsideClick: false,
      allowEscapeKey: false,
      background: 'rgba(255, 255, 255, 0.95)',
      backdrop: 'rgba(102, 126, 234, 0.4)',
      customClass: { title: 'text-xl font-bold' },
      didOpen: () => Swal.showLoading()
    });
  }

  function toast(title, icon = 'success') {
    Swal.fire({
      toast: true,
      position: 'bottom',
      icon,
      title,
      showConfirmButton: false,
      timer: 2000,
      background: 'rgba(255, 255, 255, 0.95)',
      backdrop: 'none'
    });
  }

  /* ===== App State ===== */
  let liffProfile = null;
  let userId = '';
  let boundCID = '';
  let monthsCache = [];

  /* ===== Main App Flow ===== */
  async function main() {
    try {
      applyScale(1.0);

      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) liff.login();

      const prof = await liff.getProfile();
      liffProfile = prof;
      userId = prof.userId;

      const init = await apiGet({ action: 'getorinit', uid: userId });
      if (!init.ok) throw new Error(init.error || 'init error');

      if (init.registered) {
        boundCID = init.profile.cid;
        $('#hero-avatar').src = init.profile.linepic || prof.pictureUrl || '';
        $('#hero-name').textContent = init.profile.linename || prof.displayName || '-';
        await renderHome(boundCID);
      } else {
        hide('#loader');
        show('#view-register');
        $('#reg-avatar').src = prof.pictureUrl || '';
        $('#reg-name').textContent = prof.displayName || '-';
      }
    } catch (err) {
      hide('#loader');
      Swal.fire({
        title: 'เกิดข้อผิดพลาด',
        text: err.message,
        icon: 'error',
        background: 'rgba(255, 255, 255, 0.95)',
        backdrop: 'rgba(102, 126, 234, 0.4)',
        customClass: { title: 'text-xl font-bold' }
      });
    }
  }

  async function renderHome(cid) {
    loading('กำลังโหลดข้อมูล...');
    const st = await apiGet({ action: 'status', cid });
    Swal.close();

    if (!st.ok) {
      Swal.fire({
        title: 'โหลดข้อมูลไม่สำเร็จ',
        text: st.error || '',
        icon: 'error',
        background: 'rgba(255, 255, 255, 0.95)',
        backdrop: 'rgba(102, 126, 234, 0.4)',
        customClass: { title: 'text-xl font-bold' }
      });
      return;
    }

    monthsCache = st.months || [];
    $('#hero-name').textContent = st.info?.linename || liffProfile?.displayName || '-';
    $('#hero-avatar').src = st.info?.linepic || liffProfile?.pictureUrl || '';
    $('#hero-cid').textContent = cid;
    $('#hero-moo').textContent = st.info?.moo || '-';

    hide('#loader');
    show('#hero-section');
    show('#reports-section');
    
    $('#cards').innerHTML = monthsCache.map(cardTemplate).join('');
  }

  /* ===== Register Handler ===== */
  $('#btn-register')?.addEventListener('click', async () => {
    const cid = onlyDigit($('#cid').value);
    
    if (!okCID(cid)) {
      Swal.fire({
        title: 'ข้อมูลไม่ถูกต้อง',
        text: 'กรุณากรอกเลขบัตร 13 หลัก',
        icon: 'warning',
        background: 'rgba(255, 255, 255, 0.95)',
        backdrop: 'rgba(102, 126, 234, 0.4)',
        customClass: { title: 'text-xl font-bold' }
      });
      return;
    }

    loading('กำลังลงทะเบียน...');
    const rs = await apiPost({
      action: 'register',
      cid,
      uid: userId,
      linename: liffProfile?.displayName || '',
      linepic: liffProfile?.pictureUrl || ''
    });
    Swal.close();

    if (!rs.ok) {
      Swal.fire({
        title: 'ลงทะเบียนไม่สำเร็จ',
        text: rs.error || '',
        icon: 'error',
        background: 'rgba(255, 255, 255, 0.95)',
        backdrop: 'rgba(102, 126, 234, 0.4)',
        customClass: { title: 'text-xl font-bold' }
      });
      return;
    }

    boundCID = cid;
    Swal.fire({
      title: 'สำเร็จ',
      text: 'ลงทะเบียนเรียบร้อย',
      icon: 'success',
      background: 'rgba(255, 255, 255, 0.95)',
      backdrop: 'rgba(102, 126, 234, 0.4)',
      customClass: { title: 'text-xl font-bold' }
    });
    
    hide('#view-register');
    await renderHome(boundCID);
  });

  /* ===== Refresh Handler ===== */
  const btnRefresh = $('#btn-refresh');
  const iconRefresh = $('#icon-refresh');
  let refreshing = false;
  let lastRefreshAt = 0;

  function setRefreshBusy(busy) {
    refreshing = busy;
    btnRefresh.disabled = busy;
    if (busy) {
      iconRefresh.classList.add('spinning');
    } else {
      iconRefresh.classList.remove('spinning');
    }
  }

  async function refreshData() {
    if (refreshing) return;
    
    const now = Date.now();
    if (now - lastRefreshAt < 1200) return;
    lastRefreshAt = now;

    try {
      setRefreshBusy(true);
      
      if (boundCID) {
        await renderHome(boundCID);
        toast('อัปเดตข้อมูลแล้ว', 'success');
      } else {
        await main();
      }
    } catch (err) {
      Swal.fire({
        icon: 'error',
        title: 'รีเฟรชไม่สำเร็จ',
        text: err.message,
        background: 'rgba(255, 255, 255, 0.95)',
        backdrop: 'rgba(102, 126, 234, 0.4)',
        customClass: { title: 'text-xl font-bold' }
      });
    } finally {
      setRefreshBusy(false);
    }
  }

  btnRefresh?.addEventListener('click', refreshData);

  // Auto-refresh on visibility change
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && boundCID) {
      refreshData();
    }
  });

  /* ===== Start App ===== */
  main();
  </script>
</body>
</html>
