<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
<title>Smart Care – ตรวจสอบแผน vs ผลการปฏิบัติงาน</title>

<!-- Tailwind + SweetAlert2 -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  :root { --a11y-scale:1 }
  html { font-size: calc(16px * var(--a11y-scale)); text-size-adjust:100%; -webkit-text-size-adjust:100% }
  body {
    min-height: 100vh;
    background: radial-gradient(120% 140% at 0% 0%, #C084FC 0%, #A78BFA 30%, #8B5CF6 55%, #F472B6 90%) fixed;
  }
  .glass { background: rgba(255,255,255,.85); backdrop-filter: blur(14px) }
  .card  { border-radius: 18px; background: #fff; box-shadow: 0 10px 26px rgba(147,51,234,.15) }
  .btn   { @apply inline-flex items-center justify-center font-semibold rounded-xl px-4 py-2 }
  .btn-primary { color:#fff; background: linear-gradient(135deg,#8B5CF6,#F472B6) }
  .btn-ghost   { background:#fff; color:#6b21a8; border:1px solid #e5e7eb }
  .chip { @apply text-xs font-bold px-2 py-1 rounded-full }
  .chip-ok   { background:#DCFCE7; color:#065F46 }
  .chip-bad  { background:#FEE2E2; color:#991B1B }
  .chip-warn { background:#FEF3C7; color:#92400E }
  .sticky-head th { position: sticky; top: 0; background: #f8fafc; z-index: 1 }
  @media (prefers-reduced-motion: reduce){ *{ animation-duration:.01ms!important; transition-duration:.01ms!important } }
</style>
</head>
<body class="p-4">
  <div class="max-w-7xl mx-auto space-y-4">

    <!-- Header -->
    <header class="glass rounded-2xl p-4 text-white flex items-center justify-between"
      style="background: linear-gradient(135deg,#8B5CF6 0%,#F472B6 100%); box-shadow: 0 10px 24px rgba(147,51,234,.35);">
      <div>
        <div class="text-2xl font-extrabold">Smart Care – ตรวจสอบแผน/ผล</div>
        <div class="text-white/90">เทียบค่าข้อต่อข้อ + ตรวจวันที่บันทึก ≥ วันที่ส่ง</div>
      </div>
      <div class="flex gap-2">
        <button id="font-" class="w-10 h-10 bg-white/20 rounded-xl font-bold">A−</button>
        <button id="font+" class="w-10 h-10 bg-white/20 rounded-xl font-bold">A+</button>
      </div>
    </header>

    <!-- Controls -->
    <section class="glass rounded-2xl p-4">
      <div class="grid gap-3 md:grid-cols-[220px_1fr_1fr_auto] items-end">
        <div>
          <label class="text-sm text-slate-600 font-semibold">เดือน</label>
          <select id="selMonth" class="w-full rounded-xl border border-slate-200 px-3 py-2 outline-none focus:ring-2 focus:ring-violet-300"></select>
        </div>
        <div>
          <label class="text-sm text-slate-600 font-semibold">ค้นหา (เลขบัตร 13 หลัก – ไม่ใส่คือทั้งเดือน)</label>
          <input id="inpCid" class="w-full rounded-xl border border-slate-200 px-3 py-2 outline-none focus:ring-2 focus:ring-violet-300" placeholder="เช่น 11698xxxxxxxx">
        </div>
        <div class="flex gap-2">
          <button id="btnCompare" class="btn btn-primary w-full">ตรวจสอบ</button>
          <button id="btnExport"  class="btn btn-ghost w-full" disabled>ส่งออก CSV</button>
        </div>
        <div class="justify-self-end hidden md:block">
          <span id="sumBox" class="chip chip-warn">ยังไม่ได้ตรวจ</span>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section id="resultWrap" class="space-y-4"></section>

    <footer class="text-center text-white/80 text-xs pt-4">&copy; Smart Care</footer>
  </div>

<script>
/* ===== Config ===== */
// ใส่ URL /exec ของสคริปต์ check.gs (ตัวเดียวกับที่รองรับ action=months, compare)
const CHECK_API = 'https://script.google.com/macros/s/AKfycbyMw5-blLLvHe36-KvCSEO_Rc1iVRs3s7SthxCbXQJQUmmAceJYf41XBTCD5RfXZSAY/exec';

/* ===== A11y Font Scale ===== */
const SCALE_KEY='check_a11y_scale';
const setScale = v => { const s=Math.min(1.6,Math.max(0.9,v)); document.documentElement.style.setProperty('--a11y-scale',s); localStorage.setItem(SCALE_KEY,s); };
(() => { const s=parseFloat(localStorage.getItem(SCALE_KEY)||'1'); setScale(isNaN(s)?1:s); })();
document.getElementById('font-').onclick=()=>{ const c=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--a11y-scale'))||1; setScale(c-0.1); };
document.getElementById('font+').onclick=()=>{ const c=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--a11y-scale'))||1; setScale(c+0.1); };

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const onlyDigit = s => String(s||'').replace(/[^\d]/g,'');
const okCID = s => onlyDigit(s).length===13;
function loading(t='กำลังประมวลผล…'){ Swal.fire({title:t, allowOutsideClick:false, allowEscapeKey:false, didOpen:()=>Swal.showLoading()}); }
function toastOK(t='สำเร็จ'){ Swal.fire({icon:'success', title:t, timer:1200, showConfirmButton:false}); }
function toastErr(t='เกิดข้อผิดพลาด'){ Swal.fire({icon:'error', title:'ไม่สำเร็จ', text:t}); }
async function apiGet(params){
  const url=new URL(CHECK_API);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const res=await fetch(url.toString(),{method:'GET'});
  return res.json();
}

/* ===== UI Build ===== */
const METRIC_KEYS = ['1.1','1.1.1','1.1.2','1.2','1.2.1','1.2.2','1.3','1.3.1','1.3.2','1.3.3','1.4','2.1','2.2','2.3','2.4','2.5','2.6','3.1','4.1','5.1','5.2','6(1)','6(2)','6(3)','7(1)','7(2)','8.1','8(1)','8(2)','9.1','9.2'];

function fmtDate(s){ return s||'-'; }
function buildCard(person){
  const { cid, name, moo, planDate, reportDate, dateOk, metrics, okAll, fails } = person;

  const head =
  `<div class="flex flex-wrap items-center justify-between gap-2">
      <div class="font-bold text-lg">${name||'-'} <span class="text-slate-500 font-normal">• หมู่ ${moo||'-'}</span></div>
      <div class="flex items-center gap-2">
        ${ okAll ? `<span class="chip chip-ok">ผ่านทั้งหมด</span>` : `<span class="chip chip-bad">ไม่ผ่าน</span>`}
        ${ dateOk ? `<span class="chip chip-ok">วันที่ถูกต้อง</span>` : `<span class="chip chip-bad">วันที่ผิด</span>`}
        <span class="text-slate-600 text-sm">CID: <span class="font-mono">${cid}</span></span>
      </div>
   </div>`;

  const dateRow =
  `<div class="grid md:grid-cols-2 gap-2 text-sm">
      <div class="rounded-xl bg-slate-50 p-3">วันที่ส่ง (แผน): <b>${fmtDate(planDate)}</b></div>
      <div class="rounded-xl bg-slate-50 p-3">วันที่บันทึก (ผล): <b>${fmtDate(reportDate)}</b></div>
   </div>`;

  // table metrics
  const thead = `<tr class="sticky-head">
      <th class="text-left px-2 py-2">ข้อ</th>
      <th class="text-right px-2 py-2">แผน</th>
      <th class="text-right px-2 py-2">ผล</th>
      <th class="text-center px-2 py-2">สถานะ</th>
    </tr>`;

  const rows = metrics.map(m=>{
    const stat = m.ok ? `<span class="chip chip-ok">ผ่าน</span>` : `<span class="chip chip-bad">ไม่ผ่าน</span>`;
    return `<tr class="border-b">
      <td class="px-2 py-2">${m.key}</td>
      <td class="px-2 py-2 text-right">${m.plan}</td>
      <td class="px-2 py-2 text-right">${m.report}</td>
      <td class="px-2 py-2 text-center">${stat}</td>
    </tr>`;
  }).join('');

  const failBox = !okAll ? `<div class="mt-2 text-sm text-rose-700">สรุปข้อไม่ผ่าน: ${fails.join(' ; ')}</div>` : '';

  return `<article class="card p-4">
    ${head}
    <div class="mt-2">${dateRow}</div>
    <div class="mt-3 overflow-auto border rounded-xl">
      <table class="min-w-[520px] w-full">
        <thead>${thead}</thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    ${failBox}
  </article>`;
}

function renderSummary(sum){
  const el = $('#sumBox');
  el.className = 'chip ' + (sum.failed>0 ? 'chip-bad' : 'chip-ok');
  el.textContent = `รวม ${sum.total} ราย • ผ่าน ${sum.passed} • ไม่ผ่าน ${sum.failed}`;
}

/* ===== CSV export ===== */
function toCSV(arr){
  if(!arr || !arr.length) return '';
  const esc = v => `"${String(v??'').replaceAll('"','""')}"`;
  const head = Object.keys(arr[0]);
  const lines = [ head.map(esc).join(',') ];
  arr.forEach(r=>{
    lines.push( head.map(h=>esc(r[h])) .join(',') );
  });
  return lines.join('\n');
}
function buildExportData(payload){
  // flatten each person to one row summarizing fails, plus per metric columns (plan_x, report_x, ok_x)
  const rows = [];
  payload.results.forEach(p=>{
    const row = {
      เดือน: payload.month,
      CID: p.cid,
      ชื่อ: p.name || '',
      หมู่: p.moo || '',
      วันที่ส่งแผน: p.planDate || '',
      วันที่บันทึกผล: p.reportDate || '',
      วันที่ถูกต้อง: p.dateOk ? 'OK' : 'NOT_OK',
      ผ่านทั้งหมด: p.okAll ? 'OK' : 'NOT_OK',
      สรุปข้อไม่ผ่าน: p.fails.join(' ; ')
    };
    METRIC_KEYS.forEach(k=>{
      const m = p.metrics.find(x=>x.key===k) || {plan:'',report:'',ok:false};
      row[`แผน_${k}`] = m.plan;
      row[`ผล_${k}`]  = m.report;
      row[`สถานะ_${k}`] = m.ok ? 'OK' : 'NOT_OK';
    });
    rows.push(row);
  });
  return rows;
}

/* ===== Events ===== */
async function loadMonths(){
  try{
    const res = await apiGet({ action:'months' });
    const sel = $('#selMonth'); sel.innerHTML='';
    if(!res.ok){ throw new Error(res.error||'โหลดเดือนไม่สำเร็จ'); }
    (res.months||[]).forEach(m=>{
      const op=document.createElement('option'); op.textContent = m; op.value = m; sel.appendChild(op);
    });
  }catch(err){ toastErr(err.message); }
}

$('#btnCompare').addEventListener('click', async ()=>{
  const month = $('#selMonth').value;
  const cidIn = $('#inpCid').value.trim();
  const cid = cidIn ? onlyDigit(cidIn) : '';

  if(!month){ toastErr('กรุณาเลือกเดือน'); return; }
  if(cidIn && !okCID(cid)){ toastErr('เลขบัตรไม่ถูกต้อง'); return; }

  try{
    loading('กำลังตรวจสอบ…');
    const res = await apiGet(cid ? {action:'compare', month, cid} : {action:'compare', month});
    Swal.close();
    if(!res.ok){ throw new Error(res.error||'ตรวจสอบไม่สำเร็จ'); }

    renderSummary(res.summary);

    const wrap = $('#resultWrap'); wrap.innerHTML='';
    if(!res.results.length){
      wrap.innerHTML = `<div class="card p-6 text-center text-slate-600">ไม่พบข้อมูลในเดือน <b>${month}</b></div>`;
      $('#btnExport').disabled = true;
      return;
    }

    const list = res.results.map(buildCard).join('');
    wrap.innerHTML = list;

    // enable export
    $('#btnExport').disabled = false;
    $('#btnExport').dataset.csv = toCSV(buildExportData(res));
    toastOK('ตรวจสอบเสร็จแล้ว');
  }catch(err){
    Swal.close(); toastErr(err.message);
  }
});

$('#btnExport').addEventListener('click', ()=>{
  const csv = $('#btnExport').dataset.csv || '';
  if(!csv){ return; }
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const m = $('#selMonth').value || 'month';
  a.download = `check-result-${m}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

/* ===== Init ===== */
loadMonths();
</script>
</body>
</html>
