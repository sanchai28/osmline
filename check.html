<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
<title>Smart Care – ตรวจสอบแผน vs ผลการปฏิบัติงาน</title>

<!-- Tailwind & SweetAlert2 -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; --a11y-scale:1; font-size:calc(16px * var(--a11y-scale)); }
  body{
    min-height:100vh;
    background: radial-gradient(120% 140% at 0% 0%, #C084FC 0%, #A78BFA 30%, #8B5CF6 55%, #F472B6 90%) fixed;
  }
  .glass{ background: rgba(255,255,255,.85); backdrop-filter: blur(14px); }
  .card{ border-radius: 18px; background: rgba(255,255,255,.98); box-shadow: 0 10px 22px rgba(168,85,247,.16); }
  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; border-radius:14px; padding:.65rem .9rem; font-weight:700; color:white; background: linear-gradient(135deg,#A78BFA 0%,#F472B6 100%); box-shadow: 0 10px 22px rgba(168,85,247,.25); }
  .btn-ghost{ background:#fff; color:#6b21a8; border:1px solid #e5e7eb; }
  .badge{ display:inline-flex; align-items:center; gap:.25rem; padding:.32rem .6rem; border-radius:9999px; font-weight:700; font-size:.85rem;}
  .b-ok{ background:#D1FAE5; color:#065F46; }
  .b-warn{ background:#FEF3C7; color:#92400E; }
  .b-bad{ background:#FEE2E2; color:#991B1B; }
  .chip{ display:inline-flex; align-items:center; gap:.3rem; padding:.2rem .5rem; border-radius:9999px; font-weight:700; font-size:.8rem; border:1px solid #e5e7eb; background:#fff; }
  .chip-bad{ background:#FEF2F2; color:#991B1B; border-color:#fecaca; }
  .chip-ok{ background:#F0FDF4; color:#166534; border-color:#bbf7d0; }
  .sticky-header th{ position:sticky; top:0; background:#fff; z-index:5; }
  .monos{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New",monospace; }
  @media (prefers-reduced-motion: reduce){
    *{ animation-duration:.01ms !important; transition-duration:.01ms !important; }
  }
</style>
</head>
<body class="p-4">
  <div class="max-w-7xl mx-auto space-y-4">

    <!-- Header -->
    <header class="glass rounded-2xl p-4 text-white flex items-center justify-between"
            style="background: linear-gradient(135deg,#8B5CF6 0%,#F472B6 100%); box-shadow: 0 10px 24px rgba(147,51,234,.35);">
      <div>
        <div class="text-2xl font-extrabold">Smart Care – ตรวจสอบแผนกับผล</div>
        <div class="text-white/90">ตรวจข้อต่อข้อ (ผล ≥ แผน) + วันที่บันทึก ≥ วันที่ส่ง</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="font-down" class="w-10 h-10 bg-white/20 rounded-xl font-bold">A−</button>
        <button id="font-up"   class="w-10 h-10 bg-white/20 rounded-xl font-bold">A+</button>
      </div>
    </header>

    <!-- Controls -->
    <section class="card p-4">
      <div class="grid md:grid-cols-[220px_1fr_1fr_auto] gap-3 items-end">
        <div>
          <label class="text-slate-600 text-sm font-semibold">เดือน</label>
          <select id="selMonth" class="w-full border rounded-lg p-2">
            <option value="">— กำลังโหลดเดือน —</option>
          </select>
        </div>

        <div>
          <label class="text-slate-600 text-sm font-semibold">ค้นหา (ชื่อ/เลขบัตร/หมู่บ้าน)</label>
          <input id="txtSearch" type="text" class="w-full border rounded-lg p-2" placeholder="พิมพ์คำค้น">
        </div>

        <div class="flex gap-3 items-center">
          <div class="flex items-center gap-2">
            <input id="onlyFailed" type="checkbox" class="w-4 h-4">
            <label for="onlyFailed" class="text-slate-700">แสดงเฉพาะไม่ผ่าน</label>
          </div>
          <div class="flex items-center gap-2">
            <input id="compact" type="checkbox" class="w-4 h-4">
            <label for="compact" class="text-slate-700">ตารางแบบกระชับ</label>
          </div>
        </div>

        <div class="flex gap-2 justify-end">
          <button id="btnLoad" class="btn">ตรวจสอบ</button>
          <button id="btnCopy" class="btn-ghost">คัดลอกรายการที่ไม่ผ่าน</button>
        </div>
      </div>

      <div class="mt-3 flex flex-wrap gap-2 items-center">
        <div id="sumTotal"  class="badge b-warn">ทั้งหมด 0</div>
        <div id="sumPass"   class="badge b-ok">ผ่าน 0</div>
        <div id="sumFail"   class="badge b-bad">ไม่ผ่าน 0</div>
        <div class="text-xs text-slate-500">เกณฑ์: ผล ≥ แผน และ วันที่บันทึก ≥ วันที่ส่ง</div>
      </div>
    </section>

    <!-- Results -->
    <section id="resultWrap" class="card p-0 overflow-hidden">
      <div class="overflow-auto">
        <table id="tbl" class="w-full">
          <thead class="sticky-header">
            <tr>
              <th class="p-3 text-left w-[60px]">ลำดับ</th>
              <th class="p-3 text-left">สถานะ</th>
              <th class="p-3 text-left">ชื่อ</th>
              <th class="p-3 text-left">เลขบัตร</th>
              <th class="p-3 text-left">หมู่</th>
              <th class="p-3 text-left">วันที่ส่ง</th>
              <th class="p-3 text-left">วันที่บันทึก</th>
              <th class="p-3 text-left">ไม่ผ่าน (ตัวชี้วัด)</th>
              <th class="p-3 text-left">รายละเอียด</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <section class="text-xs text-slate-600">
      <div class="font-semibold">คำอธิบาย:</div>
      <ul class="list-disc pl-6">
        <li><span class="badge b-ok">ผ่าน</span> = ผลทุกข้อ ≥ แผน และ วันที่บันทึก ≥ วันที่ส่ง</li>
        <li><span class="badge b-bad">ไม่ผ่าน</span> = มีอย่างน้อยหนึ่งข้อที่ผล &lt; แผน หรือ วันที่บันทึก &lt; วันที่ส่ง</li>
        <li>คลิกปุ่ม “รายละเอียด” เพื่อดูเทียบตัวเลขทุกข้อ</li>
      </ul>
    </section>

  </div>

<script>
/* ========= Config ========= */
const API_BASE = 'https://script.google.com/macros/s/AKfycbyMw5-blLLvHe36-KvCSEO_Rc1iVRs3s7SthxCbXQJQUmmAceJYf41XBTCD5RfXZSAY/exec'; // ใส่ URL /exec ของ check.gs

/* ========= A11y font scale ========= */
const SCALE_KEY='check_a11y_scale';
function applyScale(v){ const n=Math.min(1.6,Math.max(0.9,v)); document.documentElement.style.setProperty('--a11y-scale',String(n)); localStorage.setItem(SCALE_KEY,String(n)); }
function loadScale(){ const s=parseFloat(localStorage.getItem(SCALE_KEY)||'1'); applyScale(isNaN(s)?1:s); }
document.getElementById('font-down').addEventListener('click',()=>{ const c=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--a11y-scale'))||1; applyScale(c-0.1); });
document.getElementById('font-up').addEventListener('click',()=>{ const c=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--a11y-scale'))||1; applyScale(c+0.1); });
loadScale();

/* ========= Helpers ========= */
const $ = s => document.querySelector(s);
function loading(title='กำลังโหลด…'){ Swal.fire({title, allowOutsideClick:false, allowEscapeKey:false, didOpen:()=>Swal.showLoading()}); }
function toastErr(msg='เกิดข้อผิดพลาด'){ Swal.fire({icon:'error', title:'ไม่สำเร็จ', text:msg}); }
function toastOK(msg='สำเร็จ'){ Swal.fire({icon:'success', title:msg, timer:1200, showConfirmButton:false}); }
function qs(obj){ const u=new URL(API_BASE); Object.entries(obj).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString(); }
function onlyDigit(s){ return String(s||'').replace(/[^\d]/g,''); }

/* ========= Load months on start ========= */
async function loadMonths(){
  try{
    const res = await fetch(qs({action:'months'}));
    const js = await res.json();
    if(!js.ok) throw new Error(js.error||'โหลดรายชื่อเดือนไม่สำเร็จ');
    const sel = $('#selMonth'); sel.innerHTML='';
    sel.append(new Option('— เลือกเดือน —',''));
    (js.months||[]).forEach(m=> sel.append(new Option(m,m)) );
  }catch(err){ toastErr(err.message); }
}
loadMonths();

/* ========= State ========= */
let currentData = null;

/* ========= Event handlers ========= */
$('#btnLoad').addEventListener('click', async ()=>{
  const month = $('#selMonth').value;
  if(!month){ toastErr('กรุณาเลือกเดือน'); return; }
  await runCompare(month);
});

$('#txtSearch').addEventListener('input', ()=> renderTable(currentData));
$('#onlyFailed').addEventListener('change', ()=> renderTable(currentData));
$('#compact').addEventListener('change', ()=> renderTable(currentData));
$('#btnCopy').addEventListener('click', copyFailedSummary);

/* ========= Core: fetch & render ========= */
async function runCompare(month){
  try{
    loading('กำลังตรวจสอบ…');
    const url = qs({action:'compare', month});
    const res = await fetch(url);
    const js  = await res.json();
    Swal.close();
    if(!js.ok) throw new Error(js.error||'ดึงข้อมูลไม่สำเร็จ');
    currentData = js;
    renderSummary(js.summary);
    renderTable(js);
  }catch(err){ Swal.close(); toastErr(err.message); }
}

function renderSummary(sum){
  $('#sumTotal').textContent = `ทั้งหมด ${sum?.total||0}`;
  $('#sumPass').textContent  = `ผ่าน ${sum?.passed||0}`;
  $('#sumFail').textContent  = `ไม่ผ่าน ${sum?.failed||0}`;
}

function renderTable(js){
  const tbody = $('#tbody');
  tbody.innerHTML = '';
  if(!js || !js.results) return;

  const q = ($('#txtSearch').value||'').trim().toLowerCase();
  const onlyFailed = $('#onlyFailed').checked;
  const compact = $('#compact').checked;

  let list = js.results.slice();
  if (q){
    list = list.filter(r=>{
      return (r.name||'').toLowerCase().includes(q) ||
             (r.cid||'').includes(q) ||
             (r.moo||'').toString().includes(q);
    });
  }
  if (onlyFailed){
    list = list.filter(r=>!r.okAll);
  }

  if (!list.length){
    tbody.innerHTML = `<tr><td class="p-4 text-center text-slate-500" colspan="9">ไม่พบข้อมูลตามเงื่อนไขที่เลือก</td></tr>`;
    return;
  }

  list.forEach((r,idx)=>{
    const status = r.okAll
      ? `<span class="badge b-ok">ผ่าน</span>`
      : `<span class="badge b-bad">ไม่ผ่าน</span>`;

    const fails = (r.fails||[]).length
      ? r.fails.map(x=>`<span class="chip chip-bad">${escapeHtml(x)}</span>`).join(' ')
      : `<span class="chip chip-ok">ผ่านทุกตัวชี้วัด</span>`;

    const row = document.createElement('tr');
    row.className = 'border-b hover:bg-violet-50/40';

    const dateCellClass = r.dateOk ? 'text-emerald-700' : 'text-rose-700 font-semibold';

    row.innerHTML = `
      <td class="p-3 text-slate-600">${idx+1}</td>
      <td class="p-3">${status}</td>
      <td class="p-3">${escapeHtml(r.name||'-')}</td>
      <td class="p-3 monos">${escapeHtml(r.cid||'-')}</td>
      <td class="p-3">${escapeHtml(r.moo||'-')}</td>
      <td class="p-3">${escapeHtml(r.planDate||'-')}</td>
      <td class="p-3 ${dateCellClass}">${escapeHtml(r.reportDate||'-')}</td>
      <td class="p-3">${fails}</td>
      <td class="p-3">
        <button class="btn-ghost px-3 py-2 rounded-lg text-sm" data-cid="${r.cid}">รายละเอียด</button>
      </td>
    `;
    // compact mode
    if (compact){
      row.querySelectorAll('td').forEach(td=> td.classList.add('py-2') );
    }
    tbody.appendChild(row);

    // detail button
    row.querySelector('button[data-cid]')?.addEventListener('click', ()=> showDetails(r));
  });
}

function showDetails(r){
  // ตารางเทียบตัวเลขทุก key
  const rows = (r.metrics||[]).map(m=>{
    const mark = m.ok ? '✅' : '❌';
    const cls  = m.ok ? 'text-emerald-700' : 'text-rose-700 font-semibold';
    return `<tr>
      <td class="border p-1">${m.key}</td>
      <td class="border p-1 text-right">${m.plan}</td>
      <td class="border p-1 text-right ${cls}">${m.report}</td>
      <td class="border p-1">${mark}</td>
    </tr>`;
  }).join('');

  const html = `
    <div class="text-left space-y-2">
      <div><b>ชื่อ:</b> ${escapeHtml(r.name||'-')} · <b>เลขบัตร:</b> <span class="monos">${escapeHtml(r.cid||'-')}</span> · <b>หมู่:</b> ${escapeHtml(r.moo||'-')}</div>
      <div><b>เดือน:</b> ${escapeHtml(r.month)} · <b>วันที่ส่ง:</b> ${escapeHtml(r.planDate||'-')} · <b>วันที่บันทึก:</b> ${escapeHtml(r.reportDate||'-')}</div>
      <div>${r.dateOk ? '<span class="badge b-ok">วันผ่าน</span>' : '<span class="badge b-bad">วันไม่ผ่าน</span>'}</div>
      <div class="overflow-auto max-h-[60vh]">
        <table class="border-collapse text-sm">
          <thead>
            <tr>
              <th class="border p-1 text-left">ตัวชี้วัด</th>
              <th class="border p-1 text-right">แผน</th>
              <th class="border p-1 text-right">ผล</th>
              <th class="border p-1 text-left">สถานะ</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      ${(r.fails||[]).length ? `<div class="text-rose-700"><b>สรุปไม่ผ่าน:</b> ${r.fails.map(x=>`<span class="chip chip-bad">${escapeHtml(x)}</span>`).join(' ')}</div>` : ''}
    </div>
  `;

  Swal.fire({
    title: r.okAll ? 'ผ่าน' : 'ไม่ผ่าน',
    html, width: Math.min(window.innerWidth*0.95, 900),
    confirmButtonText: 'ปิด',
    customClass:{ popup:'text-left' }
  });
}

function copyFailedSummary(){
  if (!currentData || !currentData.results) return;
  const fail = currentData.results.filter(r=>!r.okAll);
  if (!fail.length){ toastOK('ทุกคนผ่านแล้ว!'); return; }
  const lines = [
    `สรุปไม่ผ่าน เดือน ${currentData.month} (${fail.length}/${currentData.results.length})`,
    ...fail.map(r=>{
      return `• ${r.name||'-'} (${r.cid||''}) หมู่ ${r.moo||'-'} — ไม่ผ่าน: ${r.fails.join(' ; ')}`;
    })
  ];
  const text = lines.join('\n');
  navigator.clipboard.writeText(text).then(()=> toastOK('คัดลอกแล้ว') ).catch(()=> toastErr('คัดลอกไม่สำเร็จ'));
}

function escapeHtml(s){ return String(s==null?'':s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
</script>
</body>
</html>
